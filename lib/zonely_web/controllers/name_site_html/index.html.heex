<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Say my name</title>
    <meta name="color-scheme" content="light dark" />

    <!-- Smart App Banner for iOS -->
    <!-- App Store ID: 6751617647 -->
    <meta name="apple-itunes-app" content="app-id=6751617647, app-argument=https://saymyname.qingbo.us/" />
    <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
    <link rel="icon" type="image/svg+xml" href={~p"/favicon.svg?v=3"} />
    <link rel="icon" sizes="any" type="image/svg+xml" href={~p"/favicon.svg?v=3"} />
    <link rel="icon" type="image/png" sizes="32x32" href={~p"/favicon-32x32.png?v=3"} />
    <link rel="apple-touch-icon" sizes="180x180" href={~p"/favicon-32x32.png?v=3"} />
    <style>
      :root{--bg:#ffffff;--fg:#0f172a;--muted:#64748b;--ring:#e2e8f0;--accent:#111827;--card:#f8fafc}
      @media (prefers-color-scheme: dark){:root{--bg:#0b0f17;--fg:#e5e7eb;--muted:#9ca3af;--ring:#111827;--accent:#e5e7eb;--card:#111827}}
      *{box-sizing:border-box}
      html,body{padding:0;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
      a{color:inherit}
      .wrap{max-width:820px;margin:0 auto;padding:24px}
      .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
      .brand{display:flex;align-items:center;gap:10px}
      .logo{width:28px;height:28px}
      .title{font-size:18px;font-weight:600;letter-spacing:0.2px}
      .card{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:16px}
      .input-section{display:flex;flex-direction:column;gap:12px}
      .pron-section{display:flex;flex-direction:column;gap:8px}
      .pron-label{font-size:13px;color:var(--muted);font-weight:600;margin:0}
      .pron-row{display:flex;gap:8px;align-items:start}
      .pron-text-field{flex:2}
      .pron-lang-field{flex:1;min-width:120px}
      .pron-remove{appearance:none;border:none;background:transparent;color:var(--muted);cursor:pointer;padding:8px 4px;font-size:16px;line-height:1;border-radius:8px;flex-shrink:0}
      .pron-remove:hover{color:#dc2626}
      .pron-remove:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      .add-pron{appearance:none;border:1px dashed var(--ring);background:transparent;color:var(--muted);border-radius:10px;padding:8px 12px;cursor:pointer;font-size:13px;text-align:left;width:100%}
      .add-pron:hover{border-color:#4f46e5;color:#4f46e5}
      .add-pron:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      input,select{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px;background:transparent;color:inherit}
      button{appearance:none;border:1px solid var(--ring);background:transparent;color:inherit;border-radius:10px;padding:10px 14px;cursor:pointer}
      button.primary{background:var(--accent);color:var(--bg);border-color:var(--accent)}
      .list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
      .item{display:grid;grid-template-columns:64px 1fr auto;align-items:start;column-gap:12px;row-gap:8px;border:1px solid var(--ring);border-radius:12px;padding:10px}
      .avatar{width:64px;height:64px;border-radius:50%;overflow:hidden;border:1px solid var(--ring);grid-column:1;grid-row:1 / span 2}
      .name{font-weight:600;line-height:1.2;grid-column:2;grid-row:1}
      .langs{display:flex;gap:16px;align-items:center;flex-wrap:wrap;grid-column:2;grid-row:2}
      .item > .remove{grid-column:3;grid-row:1;align-self:start}
      .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;color:var(--muted)}
      .pill.playing-user{background:#ecfdf5;color:#059669;border-color:#a7f3d0}
      .pill.playing-robot{background:#fff7ed;color:#ea580c;border-color:#fed7aa}
      .pill.animate{animation:pulse 1s ease-in-out infinite}
      .pill.loading{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;animation:breath 1.2s ease-in-out infinite}
      @keyframes breath{0%{background:#eff6ff}50%{background:#dbeafe}100%{background:#eff6ff}}
      .icon.spin{animation:spin 0.9s linear infinite;transform-origin:50% 50%}
      @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
      .entry{display:flex;align-items:center;gap:8px}
      .text{font-weight:600;color:var(--fg)}
      @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
      .empty{color:var(--muted);text-align:center;padding:28px}
      .footer{margin-top:24px;padding-top:16px;border-top:1px solid var(--ring)}
      .footer-actions{display:flex;gap:10px;justify-content:space-between;align-items:center}
      .site-links{font-size:12px;opacity:.7;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
      .muted{color:var(--muted)}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
      /* Stylish copy button */
      #share{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:none;border-radius:999px;background:#4f46e5;color:#fff;box-shadow:0 10px 20px rgba(79,70,229,.25);font-weight:600}
      #share:hover{background:#4338ca}
      #share:active{transform:translateY(1px)}
      #share:disabled{opacity:0.4;cursor:not-allowed;pointer-events:none}
      #share .icon{width:16px;height:16px}
      /* Focus-visible states for keyboard accessibility */
      input:focus-visible, select:focus-visible{outline:2px solid #4f46e5;outline-offset:2px;border-color:#4f46e5}
      button:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      .pill:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      a:focus-visible{outline:2px solid #4f46e5;outline-offset:2px;border-radius:4px}
      /* Disabled button state */
      button.primary:disabled,button.primary[disabled]{opacity:0.4;cursor:not-allowed;pointer-events:none}
      /* Error pill state */
      .pill.error{background:#fef2f2;color:#dc2626;border-color:#fca5a5;animation:none}
      @media (prefers-color-scheme: dark){
        .pill.error{background:#450a0a;color:#fca5a5;border-color:#991b1b}
        .pill.playing-user{background:#052e16;color:#4ade80;border-color:#166534}
        .pill.playing-robot{background:#431407;color:#fb923c;border-color:#9a3412}
        .pill.loading{background:#172554;color:#60a5fa;border-color:#1e3a5f;animation:breath-dark 1.2s ease-in-out infinite}
      }
      @keyframes breath-dark{0%{background:#172554}50%{background:#1e3a5f}100%{background:#172554}}
      /* Mobile tweaks */
      @media (max-width: 640px){
        .wrap{padding:16px}
        .title{font-size:16px}
        .pron-row{flex-direction:column;align-items:stretch}
        input,select{width:100%}
        button.primary{width:100%}
        .item{padding:8px;grid-template-columns:48px 1fr auto}
        .avatar{width:48px;height:48px}
        .langs{gap:10px}
        .entry{gap:6px}
        .pill{padding:6px 10px}
        .text{font-size:0.95rem}
        .footer{flex-direction:column;align-items:stretch;gap:8px}
        #share,#demo{width:100%}
        .dash-sep{display:none}
      }
      /* How it works collapsible */
      .how{margin-top:12px;border:1px solid var(--ring);border-radius:10px}
      .how-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
      .how-title{font-weight:600}
      .chev{transition:transform .2s ease}
      .how[aria-expanded="true"] .chev{transform:rotate(90deg)}
      .how-body{padding:10px 12px;padding-top:0;color:var(--muted)}
      /* Inline validation without layout shift */
      .field{position:relative}
      .hint{position:absolute;left:10px;bottom:-16px;height:14px;font-size:11px;color:#f59e0b;opacity:0;pointer-events:none;}
      .field.show-hint .hint{opacity:1}
      input.invalid, select.invalid{
        border-color:#f59e0b !important;
        box-shadow: inset 0 0 0 1px #f59e0b, 0 0 0 3px rgba(245,158,11,0.25);
        background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23f59e0b'%3E%3Cpath fill-rule='evenodd' d='M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.516 11.59c.75 1.335-.214 2.99-1.743 2.99H3.484c-1.53 0-2.494-1.655-1.743-2.99L8.257 3.1zM9 7h2v5H9V7zm0 6h2v2H9v-2z' clip-rule='evenodd'/%3E%3C/svg%3E");
        background-repeat:no-repeat; background-position:right 10px center; background-size:14px;
        padding-right:28px;
      }
      /* Collections tab bar */
      .collections-bar{display:flex;align-items:center;gap:8px;padding:8px 0;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
      .collections-bar::-webkit-scrollbar{display:none}
      .col-tab{appearance:none;border:1px solid var(--ring);background:transparent;color:var(--fg);padding:8px 16px;border-radius:999px;font-size:13px;cursor:pointer;white-space:nowrap;transition:background .15s,color .15s,transform .1s}
      .col-tab:hover{background:var(--ring)}
      .col-tab:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      .col-tab:active{transform:scale(0.98);opacity:0.9}
      .col-tab.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
      .col-tab.active:hover{opacity:0.9}
      .col-new{appearance:none;border:1px dashed var(--ring);background:transparent;color:var(--muted);padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;white-space:nowrap}
      .col-new:hover{border-color:#4f46e5;color:#4f46e5}
      .col-new:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      .col-new-input{border:1px solid var(--accent);background:transparent;color:var(--fg);padding:8px 12px;border-radius:999px;font-size:13px;outline:none;min-width:120px}
      .col-ctx{position:fixed;background:var(--card);border:1px solid var(--ring);border-radius:10px;padding:4px;z-index:100;min-width:140px;box-shadow:0 4px 16px rgba(0,0,0,.15)}
      .col-ctx-item{display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:transparent;color:var(--fg);font-size:13px;cursor:pointer;border-radius:6px}
      .col-ctx-item:hover{background:var(--ring)}
      .col-ctx-item.danger{color:#dc2626}
      .col-ctx-item.danger:hover{background:#fef2f2}
      @media (prefers-color-scheme: dark){.col-ctx-item.danger:hover{background:#451a1a}}
      /* Import banner */
      .import-banner{background:var(--card-bg,#f8fafc);border:1px solid var(--ring);border-radius:16px;padding:16px;margin-bottom:8px;display:flex;flex-direction:column;gap:12px}
      .import-banner-text{font-size:14px;color:var(--fg);line-height:1.5}
      .import-banner-text strong{font-weight:600}
      .import-banner-actions{display:flex;gap:8px;flex-wrap:wrap}
      .import-banner-actions button{padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:background .15s}
      .import-banner-actions button:focus-visible{outline:2px solid #4f46e5;outline-offset:2px}
      .import-btn-primary{background:#4f46e5;color:#fff}
      .import-btn-primary:hover{background:#4338ca}
      .import-btn-secondary{background:transparent;color:var(--fg);border:1px solid var(--ring) !important}
      .import-btn-secondary:hover{background:var(--ring)}
      .import-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-size:12px;background:var(--card-bg,#f8fafc);border:1px solid var(--ring);color:var(--muted);cursor:pointer}
      .import-pill button{background:none;border:none;color:#4f46e5;font-weight:600;cursor:pointer;padding:0;font-size:12px}
      .import-pill button:hover{text-decoration:underline}
      /* Undo toast */
      .undo-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100%);background:#1f2937;color:#fff;padding:0 16px;height:48px;border-radius:12px;display:flex;align-items:center;gap:12px;font-size:14px;z-index:200;box-shadow:0 4px 16px rgba(0,0,0,.25);transition:transform .25s ease,opacity .25s ease;opacity:0;max-width:400px;white-space:nowrap}
      .undo-toast.visible{transform:translateX(-50%) translateY(0);opacity:1}
      .undo-toast button{background:none;border:none;color:#60a5fa;font-weight:700;font-size:14px;cursor:pointer;padding:0}
      .undo-toast button:hover{text-decoration:underline}
      .undo-toast button:focus-visible{outline:2px solid #60a5fa;outline-offset:2px;border-radius:4px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="brand">
          <img class="logo" src={~p"/favicon-32x32.png?v=3"} alt="Say my name" />
          <h1 class="title">Say my name</h1>
        </div>
        <div>
          <button id="share" aria-label="Share name list" class="primary">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M13 7H7a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM5 9a2 2 0 0 1 2-2h.5V6A2.5 2.5 0 0 1 10 3.5h0A2.5 2.5 0 0 1 12.5 6V7H7.5V6Z" fill-opacity=".15"/><path d="M7.5 6V6A2.5 2.5 0 0 1 10 3.5h0A2.5 2.5 0 0 1 12.5 6V7H7.5V6Z"/></svg>
            <span class="label">Share name list</span>
          </button>
        </div>
      </div>

      <div id="import-banner" role="alert" aria-live="assertive" style="display:none"></div>

      <div class="collections-bar" id="collections-bar" role="tablist" aria-label="Collections"></div>

      <div class="card">
        <div class="input-section">
          <div class="field">
            <input id="name_input" placeholder="Name (e.g., Zhang Wei)" aria-label="Display name" autocomplete="off" />
          </div>

          <div class="pron-section" id="pron-rows" aria-label="Pronunciations">
            <p class="pron-label">Pronunciations</p>
          </div>

          <button type="button" class="add-pron" id="add-pron" aria-label="Add another pronunciation">+ Add pronunciation</button>

          <button id="add" class="primary" disabled>Add to list</button>
        </div>

        <div class="list" id="list" role="list" aria-label="Name pronunciation list">
          <%= if @names == [] do %>
            <div class="empty" role="status" aria-live="polite">No names yet. Add a name and language to begin.</div>
          <% end %>
          <%= for item <- @names do %>
            <div class="item" data-name={item.name} role="listitem">
              <img class="avatar" src={item.avatar} alt={"Avatar for #{item.name}"} />
              <div class="name"><%= item.name %></div>
              <div class="langs">
                <%= for e <- item.entries || [] do %>
                  <div class="entry">
                    <button class="pill" data-lang={e.lang} data-text={e.text} aria-label={"Play #{e.text} pronunciation"}>
                      <span class="label"></span>
                      <svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    </button>
                    <span class="text"><%= e.text %></span>
                  </div>
                <% end %>
              </div>
              <button class="remove" title="Remove" aria-label={"Remove #{item.name} from list"}>âœ•</button>
            </div>
          <% end %>
        </div>



        <div class="footer">
          <div class="muted site-links">
            <a href={"#{@base_path}/privacy"} class="muted" style="text-decoration:underline">Privacy</a>
            <span aria-hidden="true">Â·</span>
            <a href={"#{@base_path}/about"} class="muted" style="text-decoration:underline">About</a>
          </div>
        </div>
      </div>
    </div>

    <audio id="audio" preload="none"></audio>

    <script>
      const listEl = document.getElementById('list');
      const audio = document.getElementById('audio');
      const nameInputEl = document.getElementById('name_input');
      const pronRowsEl = document.getElementById('pron-rows');
      const addPronEl = document.getElementById('add-pron');
      const addEl = document.getElementById('add');
      const shareEl = document.getElementById('share');
      const demoEl = document.getElementById('demo');
      const supportedLangs = ["en-US","es-ES","fr-FR","de-DE","pt-BR","zh-CN","ja-JP","hi-IN","bn-IN","ar-SA"];
      const langNames = {"en-US":"English","zh-CN":"ä¸­æ–‡","es-ES":"EspaÃ±ol","hi-IN":"à¤¹à¤¿à¤¨à¥à¤¦à¥€","ar-SA":"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©","bn-IN":"à¦¬à¦¾à¦‚à¦²à¦¾","fr-FR":"FranÃ§ais","pt-BR":"PortuguÃªs","ja-JP":"æ—¥æœ¬èªž","de-DE":"Deutsch"};

      function langOptionsHtml(selected){
        return supportedLangs.map(l => `<option value="${l}"${l===selected?' selected':''}>${langNames[l]||l}</option>`).join('');
      }

      // --- Collections ---
      const collectionsBarEl = document.getElementById('collections-bar');
      const STORE_KEY = 'smn_collections';

      function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

      function loadStore(){
        try{
          const raw = localStorage.getItem(STORE_KEY);
          if(raw){
            const s = JSON.parse(raw);
            if(s && Array.isArray(s.collections) && s.collections.length > 0) return s;
          }
        }catch(_){}
        const def = { id: genId(), name: 'My Names', entries: [], createdAt: new Date().toISOString() };
        return { collections: [def], activeId: def.id };
      }

      function saveStore(st){
        try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(_){}
      }

      function getCurrentEntries(){
        return [...listEl.querySelectorAll('.item')].map(el => ({
          name: el.dataset.name,
          entries: [...el.querySelectorAll('.pill')].map(p => ({ lang: p.dataset.lang, text: p.dataset.text || el.dataset.name }))
        }));
      }

      function clearList(){
        listEl.querySelectorAll('.item').forEach(el => el.remove());
        const existing = listEl.querySelector('.empty');
        if(!existing){
          const d = document.createElement('div');
          d.className = 'empty';
          d.setAttribute('role', 'status');
          d.setAttribute('aria-live', 'polite');
          d.textContent = 'No names yet. Add a name and language to begin.';
          listEl.appendChild(d);
        }
      }

      function hydrateList(entries){
        clearList();
        (entries || []).forEach(item => {
          addItem(item.name, (item.entries || []).map(e => ({ text: e.text, lang: e.lang })));
        });
      }

      let store = loadStore();

      function saveActiveCollection(){
        const col = store.collections.find(c => c.id === store.activeId);
        if(col){ col.entries = getCurrentEntries(); }
        saveStore(store);
      }

      function renderTabs(){
        collectionsBarEl.innerHTML = '';
        store.collections.forEach(col => {
          const btn = document.createElement('button');
          btn.className = 'col-tab' + (col.id === store.activeId ? ' active' : '');
          btn.setAttribute('role', 'tab');
          btn.setAttribute('aria-selected', col.id === store.activeId ? 'true' : 'false');
          btn.dataset.id = col.id;
          btn.textContent = col.name;
          btn.addEventListener('click', () => switchCollection(col.id));
          btn.addEventListener('contextmenu', (e) => { e.preventDefault(); showCtxMenu(e, col); });
          collectionsBarEl.appendChild(btn);
        });
        const newBtn = document.createElement('button');
        newBtn.className = 'col-new';
        newBtn.textContent = '+ New';
        newBtn.setAttribute('aria-label', 'Create new collection');
        newBtn.addEventListener('click', () => showNewCollectionInput());
        collectionsBarEl.appendChild(newBtn);
      }

      function switchCollection(id){
        if(id === store.activeId) return;
        saveActiveCollection();
        store.activeId = id;
        saveStore(store);
        const col = store.collections.find(c => c.id === id);
        if(col){ hydrateList(col.entries); }
        renderTabs();
        refreshURL();
      }

      function showNewCollectionInput(){
        const nb = collectionsBarEl.querySelector('.col-new');
        if(!nb) return;
        const inp = document.createElement('input');
        inp.className = 'col-new-input';
        inp.placeholder = 'Collection name';
        inp.setAttribute('aria-label', 'New collection name');
        nb.replaceWith(inp);
        inp.focus();
        function finish(create){
          const name = inp.value.trim();
          if(create && name){
            saveActiveCollection();
            const col = { id: genId(), name, entries: [], createdAt: new Date().toISOString() };
            store.collections.push(col);
            store.activeId = col.id;
            saveStore(store);
            hydrateList(col.entries);
          }
          renderTabs();
          if(create && name) refreshURL();
        }
        inp.addEventListener('keydown', (e) => {
          if(e.key === 'Enter') finish(true);
          if(e.key === 'Escape') finish(false);
        });
        inp.addEventListener('blur', () => finish(false));
      }

      let ctxMenuEl = null;
      function hideCtxMenu(){ if(ctxMenuEl){ ctxMenuEl.remove(); ctxMenuEl = null; } document.removeEventListener('click', hideCtxMenu); }

      function showCtxMenu(e, col){
        hideCtxMenu();
        ctxMenuEl = document.createElement('div');
        ctxMenuEl.className = 'col-ctx';
        ctxMenuEl.style.left = e.clientX + 'px';
        ctxMenuEl.style.top = e.clientY + 'px';

        const renameBtn = document.createElement('button');
        renameBtn.className = 'col-ctx-item';
        renameBtn.textContent = 'Rename';
        renameBtn.addEventListener('click', () => { hideCtxMenu(); renameCollection(col.id); });
        ctxMenuEl.appendChild(renameBtn);

        const dupBtn = document.createElement('button');
        dupBtn.className = 'col-ctx-item';
        dupBtn.textContent = 'Duplicate';
        dupBtn.addEventListener('click', () => { hideCtxMenu(); duplicateCollection(col.id); });
        ctxMenuEl.appendChild(dupBtn);

        if(store.collections.length > 1){
          const delBtn = document.createElement('button');
          delBtn.className = 'col-ctx-item danger';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => { hideCtxMenu(); deleteCollection(col.id); });
          ctxMenuEl.appendChild(delBtn);
        }
        document.body.appendChild(ctxMenuEl);
        setTimeout(() => document.addEventListener('click', hideCtxMenu), 0);
      }

      function renameCollection(id){
        const tab = collectionsBarEl.querySelector(`.col-tab[data-id="${id}"]`);
        const col = store.collections.find(c => c.id === id);
        if(!tab || !col) return;
        const inp = document.createElement('input');
        inp.className = 'col-new-input';
        inp.value = col.name;
        inp.setAttribute('aria-label', 'Rename collection');
        tab.replaceWith(inp);
        inp.focus();
        inp.select();
        function finish(){
          const name = inp.value.trim();
          if(name){ col.name = name; saveStore(store); }
          renderTabs();
        }
        inp.addEventListener('keydown', (e) => { if(e.key==='Enter') finish(); if(e.key==='Escape'){ inp.value=col.name; finish(); } });
        inp.addEventListener('blur', finish);
      }

      function duplicateCollection(id){
        const col = store.collections.find(c => c.id === id);
        if(!col) return;
        saveActiveCollection();
        const dup = { id: genId(), name: col.name + ' (copy)', entries: JSON.parse(JSON.stringify(col.entries)), createdAt: new Date().toISOString() };
        const idx = store.collections.findIndex(c => c.id === id);
        store.collections.splice(idx + 1, 0, dup);
        store.activeId = dup.id;
        saveStore(store);
        hydrateList(dup.entries);
        renderTabs();
        refreshURL();
      }

      function deleteCollection(id){
        if(store.collections.length <= 1) return;
        const idx = store.collections.findIndex(c => c.id === id);
        store.collections.splice(idx, 1);
        if(store.activeId === id){
          store.activeId = store.collections[Math.max(0, idx - 1)].id;
          const col = store.collections.find(c => c.id === store.activeId);
          if(col) hydrateList(col.entries);
        }
        saveStore(store);
        renderTabs();
        refreshURL();
      }
      const playedUrls = new Set();
      const playedKeys = new Set();

      async function trackPlay({ provider, cacheSource, nameText, lang, isReplay }) {
        try {
          const body = {
            provider: isReplay ? 'cache_client' : (cacheSource ? `cache_${cacheSource}` : (provider || 'unknown')),
            cache_source: isReplay ? 'client' : (cacheSource || null),
            original_provider: provider || 'unknown',
            name_text: nameText,
            lang,
            platform: 'web'
          };

          await fetch('/api/analytics/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        } catch (_) {}
      }

      // Lightweight script-based language check (same set as iOS)
      function allowedScripts(code){
        const base = (code||'').split('-')[0].toLowerCase();
        switch(base){
          case 'en': case 'es': case 'fr': case 'de': case 'it': case 'pt': case 'vi': case 'id': case 'nl': case 'sv': case 'no': case 'da': case 'fi': case 'pl': case 'cs': case 'ro': case 'tr':
            return ['latin'];
          case 'zh': return ['cjk'];
          case 'ja': return ['hiragana','katakana','cjk'];
          case 'ko': return ['hangul'];
          case 'ru': case 'uk': case 'bg': case 'sr': return ['cyrillic'];
          case 'ar': case 'fa': case 'ur': return ['arabic'];
          case 'hi': return ['devanagari'];
          case 'th': return ['thai'];
          default: return ['latin','cjk','hiragana','katakana','hangul','cyrillic','arabic','devanagari','thai'];
        }
      }
      function scriptOfScalar(cp){
        if((cp>=0x41&&cp<=0x7A)||(cp>=0xC0&&cp<=0x24F)||(cp>=0x1E00&&cp<=0x1EFF)) return 'latin';
        if((cp>=0x4E00&&cp<=0x9FFF)||(cp>=0x3400&&cp<=0x4DBF)||(cp>=0xF900&&cp<=0xFAFF)) return 'cjk';
        if(cp>=0x3040&&cp<=0x309F) return 'hiragana';
        if((cp>=0x30A0&&cp<=0x30FF)||(cp>=0x31F0&&cp<=0x31FF)) return 'katakana';
        if((cp>=0xAC00&&cp<=0xD7AF)||(cp>=0x1100&&cp<=0x11FF)||(cp>=0x3130&&cp<=0x318F)) return 'hangul';
        if((cp>=0x0400&&cp<=0x04FF)||(cp>=0x0500&&cp<=0x052F)) return 'cyrillic';
        if((cp>=0x0600&&cp<=0x06FF)||(cp>=0x0750&&cp<=0x077F)||(cp>=0x08A0&&cp<=0x08FF)) return 'arabic';
        if(cp>=0x0900&&cp<=0x097F) return 'devanagari';
        if(cp>=0x0E00&&cp<=0x0E7F) return 'thai';
        return 'unknown';
      }
      function dominantScript(str){
        const counts={};
        for(const ch of str){ const s=scriptOfScalar(ch.codePointAt(0)); if(s!=='unknown'){ counts[s]=(counts[s]||0)+1; } }
        let best=null, max=0; for(const k in counts){ if(counts[k]>max){ max=counts[k]; best=k; } }
        return best;
      }
      function matchesTextToLang(text, lang){
        const t = (text||'').trim(); if(!t) return true;
        if(!supportedLangs.includes(lang)) return true;
        const dom = dominantScript(t); if(!dom) return true;
        return allowedScripts(lang).includes(dom) || dom==='unknown';
      }
      function toggleInvalid(el, flag){ el.classList.toggle('invalid', !!flag); }

      // --- Pronunciation row management ---
      let pronRowCounter = 0;
      const defaultLangOrder = ['en-US','zh-CN','ja-JP','es-ES','fr-FR','de-DE','pt-BR','hi-IN','bn-IN','ar-SA'];

      function getUsedLangs(){
        return [...pronRowsEl.querySelectorAll('.pron-row select')].map(s => s.value);
      }

      function nextDefaultLang(){
        const used = getUsedLangs();
        return defaultLangOrder.find(l => !used.includes(l)) || 'en-US';
      }

      function createPronRow(lang, text, removable){
        pronRowCounter++;
        const idx = pronRowCounter;
        const row = document.createElement('div');
        row.className = 'pron-row';
        row.dataset.idx = idx;
        const textField = document.createElement('div');
        textField.className = 'field pron-text-field';
        textField.id = `field_pron_${idx}`;
        const inp = document.createElement('input');
        inp.id = `pron_text_${idx}`;
        inp.placeholder = `Pronunciation text`;
        inp.setAttribute('aria-label', `Pronunciation ${idx} text`);
        inp.value = text || '';
        inp.autocomplete = 'off';
        textField.appendChild(inp);
        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.id = `hint_pron_${idx}`;
        hint.textContent = 'Text may not match language';
        textField.appendChild(hint);
        row.appendChild(textField);

        const langField = document.createElement('div');
        langField.className = 'field pron-lang-field';
        const sel = document.createElement('select');
        sel.id = `pron_lang_${idx}`;
        sel.setAttribute('aria-label', `Pronunciation ${idx} language`);
        sel.innerHTML = langOptionsHtml(lang || nextDefaultLang());
        langField.appendChild(sel);
        row.appendChild(langField);

        if(removable){
          const rm = document.createElement('button');
          rm.type = 'button';
          rm.className = 'pron-remove';
          rm.setAttribute('aria-label', `Remove pronunciation ${idx}`);
          rm.textContent = 'âœ•';
          rm.addEventListener('click', () => { row.remove(); validateInputs(); });
          row.appendChild(rm);
        }

        inp.addEventListener('input', () => { delete inp.dataset.autoFilled; validateInputs(); });
        inp.addEventListener('blur', validateInputs);
        inp.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !addEl.disabled){ addEl.click(); }});
        sel.addEventListener('change', validateInputs);
        pronRowsEl.appendChild(row);
        return row;
      }

      function getPronRows(){
        return [...pronRowsEl.querySelectorAll('.pron-row')];
      }

      function validateInputs(){
        const name = nameInputEl.value.trim();
        const rows = getPronRows();
        let anyMismatch = false;
        let anyText = false;
        rows.forEach(row => {
          const inp = row.querySelector('input');
          const sel = row.querySelector('select');
          const hint = row.querySelector('.hint');
          const text = inp.value.trim();
          const lang = sel.value;
          if(text) anyText = true;
          const mismatch = text && !matchesTextToLang(text, lang);
          if(mismatch) anyMismatch = true;
          toggleInvalid(inp, mismatch);
          toggleInvalid(sel, mismatch);
          if(hint){
            hint.textContent = `Text may not match ${langNames[lang]||lang}`;
            hint.style.opacity = mismatch ? '1' : '0';
          }
        });
        addEl.disabled = anyMismatch || !name || !anyText;
        return !anyMismatch;
      }

      // Auto-fill first pronunciation row text from name field
      nameInputEl.addEventListener('input', () => {
        const rows = getPronRows();
        if(rows.length > 0){
          const firstInp = rows[0].querySelector('input');
          // Only auto-fill if user hasn't manually edited the first row
          if(firstInp && (firstInp.dataset.autoFilled === '1' || !firstInp.value.trim())){
            firstInp.value = nameInputEl.value;
            firstInp.dataset.autoFilled = '1';
          }
        }
        validateInputs();
      });

      addPronEl.addEventListener('click', () => {
        createPronRow(nextDefaultLang(), '', true);
        const rows = getPronRows();
        const lastInp = rows[rows.length - 1].querySelector('input');
        if(lastInp) lastInp.focus();
        validateInputs();
      });

      // Create initial pronunciation row (not removable)
      createPronRow('en-US', '', false);
      validateInputs();
      // Unicode-safe Base64 URL helpers (for names with non-Latin chars)
      function utf8ToB64(str){
        const bytes = new TextEncoder().encode(str);
        let bin = '';
        for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
        return btoa(bin);
      }
      function b64ToUtf8(b64){
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }
      function b64UrlEncode(str){
        return utf8ToB64(str).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
      }
      function b64UrlDecode(str){
        const pad = str.length % 4 === 2 ? '==' : (str.length % 4 === 3 ? '=' : '');
        const b64 = str.replace(/-/g,'+').replace(/_/g,'/') + pad;
        return b64ToUtf8(b64);
      }
      function buildDemoUrl(){
        const demo = [
          { name: 'çŽ‹æ˜Ž', entries: [
            { lang: 'en-US', text: 'Ming Wang' },
            { lang: 'zh-CN', text: 'çŽ‹æ˜Ž' }
          ]},
          { name: 'Maria Silva', entries: [
            { lang: 'pt-BR', text: 'Maria Silva' },
            { lang: 'en-US', text: 'Maria Silva' }
          ]},
          { name: 'Ravi Kumar', entries: [
            { lang: 'hi-IN', text: 'à¤°à¤µà¤¿ à¤•à¥à¤®à¤¾à¤°' },
            { lang: 'en-US', text: 'Ravi Kumar' }
          ]},
          { name: 'Ana GarcÃ­a', entries: [
            { lang: 'es-ES', text: 'Ana GarcÃ­a' },
            { lang: 'en-US', text: 'Ana Garcia' }
          ]},
          { name: 'FranÃ§ois Dupont', entries: [
            { lang: 'fr-FR', text: 'FranÃ§ois Dupont' },
            { lang: 'en-US', text: 'Francois Dupont' }
          ]},
          { name: 'JÃ¼rgen MÃ¼ller', entries: [
            { lang: 'de-DE', text: 'JÃ¼rgen MÃ¼ller' },
            { lang: 'en-US', text: 'Juergen Mueller' }
          ]},
          { name: 'Ahmed Ali', entries: [
            { lang: 'ar-SA', text: 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ' },
            { lang: 'en-US', text: 'Ahmed Ali' }
          ]},
          { name: 'Yuki Tanaka', entries: [
            { lang: 'ja-JP', text: 'ç”°ä¸­ å‹ç´€' },
            { lang: 'en-US', text: 'Yuki Tanaka' }
          ]}
        ];
        const json = JSON.stringify(demo);
        const s = b64UrlEncode(json);
        const url = new URL(window.location.href);
        url.searchParams.set('s', s);
        return url.toString();
      }

      // footer demo link removed; keep fallback for cached pages
      if (demoEl) {
        demoEl.href = buildDemoUrl();
      }

      // --- Collections initialization ---
      const importBannerEl = document.getElementById('import-banner');
      let sharedEntries = null; // Temp entries when "just viewing"
      let sharedColName = null;

      function showImportBanner(colName, count){
        const safeN = document.createElement('strong');
        safeN.textContent = colName;
        importBannerEl.innerHTML = '';
        importBannerEl.className = 'import-banner';
        importBannerEl.style.display = '';
        const textDiv = document.createElement('div');
        textDiv.className = 'import-banner-text';
        textDiv.append('ðŸ“‹ ', safeN, ` â€” ${count} name${count !== 1 ? 's' : ''} shared with you`);
        importBannerEl.appendChild(textDiv);
        const actions = document.createElement('div');
        actions.className = 'import-banner-actions';
        const importBtn = document.createElement('button');
        importBtn.className = 'import-btn-primary';
        importBtn.textContent = 'Import as new collection';
        importBtn.addEventListener('click', () => importSharedCollection());
        actions.appendChild(importBtn);
        const viewBtn = document.createElement('button');
        viewBtn.className = 'import-btn-secondary';
        viewBtn.textContent = 'Just view for now';
        viewBtn.addEventListener('click', () => collapseImportBanner());
        actions.appendChild(viewBtn);
        importBannerEl.appendChild(actions);
      }

      function importSharedCollection(){
        if(!sharedEntries) return;
        const name = sharedColName || 'Shared List';
        const col = { id: genId(), name, entries: JSON.parse(JSON.stringify(sharedEntries)), createdAt: new Date().toISOString() };
        saveActiveCollection();
        store.collections.push(col);
        store.activeId = col.id;
        saveStore(store);
        hydrateList(col.entries);
        renderTabs();
        refreshURL();
        importBannerEl.style.display = 'none';
        importBannerEl.innerHTML = '';
        sharedEntries = null;
        sharedColName = null;
      }

      function collapseImportBanner(){
        importBannerEl.className = '';
        importBannerEl.innerHTML = '';
        const pill = document.createElement('div');
        pill.className = 'import-pill';
        pill.textContent = 'Viewing shared list Â· ';
        const importLink = document.createElement('button');
        importLink.textContent = 'Import';
        importLink.addEventListener('click', () => importSharedCollection());
        pill.appendChild(importLink);
        importBannerEl.appendChild(pill);
        importBannerEl.style.display = '';
      }

      (function(){
        try{
          const url = new URL(window.location.href);
          const hasS = url.searchParams.has('s');
          if(hasS){
            // Shared link â€” server already rendered entries in the DOM
            const cnParam = url.searchParams.get('cn');
            sharedColName = cnParam ? b64UrlDecode(cnParam) : null;
            const colName = sharedColName || 'Shared List';
            const entries = getCurrentEntries();
            if(entries && entries.length > 0){
              sharedEntries = entries;
              showImportBanner(colName, entries.length);
            }
          } else {
            // No URL state â€” load from active collection
            const col = store.collections.find(c => c.id === store.activeId);
            if(col && col.entries.length > 0){
              hydrateList(col.entries);
            }
          }
        }catch(_){ }
        renderTabs();
        refreshURL();
      })();
      function encodeState(items){
        const data = items.map(el => ({
          name: el.dataset.name,
          entries: [...el.querySelectorAll('.pill')].map(p=>({lang: p.dataset.lang, text: p.dataset.text || el.dataset.name}))
        }));
        const json = JSON.stringify(data);
        return b64UrlEncode(json);
      }

      function decodeState(s){
        try{
          const json = b64UrlDecode(s);
          return JSON.parse(json);
        }catch(_){ return []; }
      }

      function setNativeLabelEl(el, lang){
        const map = {"en-US":"English","zh-CN":"ä¸­æ–‡","es-ES":"EspaÃ±ol","hi-IN":"à¤¹à¤¿à¤¨à¥à¤¦à¥€","ar-SA":"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©","bn-IN":"à¦¬à¦¾à¦‚à¦²à¦¾","fr-FR":"FranÃ§ais","pt-BR":"PortuguÃªs","ja-JP":"æ—¥æœ¬èªž","de-DE":"Deutsch"};
        const label = map[lang] || lang;
        el.textContent = label;
        const pill = el.closest('.pill');
        if(pill){ pill.title = `${label} â€” double-click to edit text`; }
      }

      function refreshURL(){
        const items = [...listEl.querySelectorAll('.item')];
        const s = encodeState(items);
        const url = new URL(window.location.href);
        if(s && s.length>0){ url.searchParams.set('s', s); }
        else { url.searchParams.delete('s'); }
        // Add collection name to share URL
        const activeCol = store.collections.find(c => c.id === store.activeId);
        if(activeCol && s && s.length>0){ url.searchParams.set('cn', b64UrlEncode(activeCol.name)); }
        else { url.searchParams.delete('cn'); }
        history.replaceState(null, '', url.toString());
        // Update visible deep-link button
        if(shareEl){ shareEl.dataset.url = url.toString(); }
        // Persist to active collection
        saveActiveCollection();
        // Disable share when list is empty
        const hasItems = items.length > 0;
        if(shareEl){ shareEl.disabled = !hasItems; shareEl.title = hasItems ? '' : 'Add some names first'; }
      }

      function avatarFor(name){
        const seed = name.toLowerCase().replace(/[^\w\s]/g,'').replace(/\s+/g,'-');
        return `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9&size=48`;
      }

      function addItem(displayName, pronunciations){
        if(!displayName && (!pronunciations || pronunciations.length === 0)) return;
        const name = displayName || (pronunciations[0] && pronunciations[0].text) || '';
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.name = name;
        el.setAttribute('role', 'listitem');
        el.innerHTML = `
          <img class="avatar" src="${avatarFor(name)}" alt="Avatar for ${name}" />
          <div class="name"></div>
          <div class="langs"></div>
          <button class="remove" title="Remove" aria-label="Remove ${name} from list">âœ•</button>`;
        el.querySelector('.name').textContent = name;

        const langsEl = el.querySelector('.langs');
        (pronunciations || []).forEach(p => {
          if(!p.text) return;
          const entry = document.createElement('div');
          entry.className = 'entry';
          const pill = document.createElement('button');
          pill.className = 'pill';
          pill.dataset.lang = p.lang || 'en-US';
          pill.dataset.text = p.text;
          pill.setAttribute('aria-label', `Play ${p.text} pronunciation`);
          pill.innerHTML = `<span class="label"></span> <svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
          entry.appendChild(pill);
          const textSpan = document.createElement('span');
          textSpan.className = 'text';
          textSpan.textContent = p.text;
          entry.appendChild(textSpan);
          langsEl.appendChild(entry);
          setNativeLabelEl(pill.querySelector('.label'), pill.dataset.lang);
        });

        listEl.appendChild(el);
        attachItemEvents(el);
        const empty = listEl.querySelector('.empty'); if(empty) empty.remove();
        refreshURL();
      }

      let currentPill = null;

      function setPillState(pill, state){
        pill.classList.remove('playing','loading','playing-user','playing-robot','animate','error');
        const icon = pill.querySelector('svg');
        if(state==='loading'){
          pill.classList.add('loading');
          if(icon){
            icon.outerHTML = '<svg class="icon spin" width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" opacity="0.25"/><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
          }
        }else if(state==='error'){
          pill.classList.add('error');
          if(icon){
            icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
          }
          // Auto-reset after 3 seconds
          setTimeout(()=>{ if(pill.classList.contains('error')) resetPillState(pill); }, 3000);
        }else if(state==='playing-user'){
          pill.classList.add('playing-user','animate');
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>';
        }else if(state==='playing-robot'){
          pill.classList.add('playing-robot','animate');
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C13.1 2 14 2.9 14 4V6H16C17.1 6 18 6.9 18 8V18C18 19.1 17.1 20 16 20H8C6.9 20 6 19.1 6 18V8C6 6.9 6.9 6 8 6H10V4C10 2.9 10.9 2 12 2ZM12 4C11.4 4 11 4.4 11 5V6H13V5C13 4.4 12.6 4 12 4ZM9 10C8.4 10 8 10.4 8 11S8.4 12 9 12 10 11.6 10 11 9.6 10 9 10ZM15 10C14.4 10 14 10.4 14 11S14.4 12 15 12 16 11.6 16 11 15.6 10 15 10ZM8 14H16V16H8V14Z"/></svg>';
        }else{
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>';
        }
      }

      function resetPillState(pill){ setPillState(pill, 'idle'); }

      function stopAllPronunciations(){
        try { audio.pause(); audio.currentTime = 0; } catch(_){ }
        try { if (window.speechSynthesis) speechSynthesis.cancel(); } catch(_){ }
        document.querySelectorAll('.pill.playing-user, .pill.playing-robot, .pill.loading, .pill.error')
          .forEach(p => setPillState(p, 'idle'));
        currentPill = null;
      }

      // --- Undo on remove ---
      let pendingRemoval = null;
      let undoTimer = null;
      let toastEl = null;

      function finalizeRemoval(){
        pendingRemoval = null;
        if(undoTimer){ clearTimeout(undoTimer); undoTimer = null; }
        hideUndoToast();
      }

      function showUndoToast(name){
        if(!toastEl){
          toastEl = document.createElement('div');
          toastEl.className = 'undo-toast';
          toastEl.setAttribute('role', 'status');
          toastEl.setAttribute('aria-live', 'polite');
          document.body.appendChild(toastEl);
        }
        toastEl.innerHTML = '';
        const span = document.createElement('span');
        span.textContent = `"${name}" removed`;
        toastEl.appendChild(span);
        const btn = document.createElement('button');
        btn.textContent = 'Undo';
        btn.addEventListener('click', () => undoRemoval());
        toastEl.appendChild(btn);
        // Force reflow then show
        toastEl.classList.remove('visible');
        void toastEl.offsetWidth;
        toastEl.classList.add('visible');
      }

      function hideUndoToast(){
        if(toastEl){ toastEl.classList.remove('visible'); }
      }

      function removeWithUndo(item){
        // If there's a pending removal, finalize it first (one toast at a time)
        if(pendingRemoval) finalizeRemoval();
        // Record the item's position
        const siblings = [...listEl.querySelectorAll('.item')];
        const idx = siblings.indexOf(item);
        const name = item.dataset.name;
        item.remove();
        refreshURL();
        pendingRemoval = { element: item, index: idx };
        showUndoToast(name);
        undoTimer = setTimeout(() => finalizeRemoval(), 5000);
      }

      function undoRemoval(){
        if(!pendingRemoval) return;
        const { element, index } = pendingRemoval;
        // Re-insert at original position
        const items = listEl.querySelectorAll('.item');
        const empty = listEl.querySelector('.empty');
        if(empty) empty.remove();
        if(index >= items.length){ listEl.appendChild(element); }
        else { listEl.insertBefore(element, items[index]); }
        if(undoTimer){ clearTimeout(undoTimer); undoTimer = null; }
        pendingRemoval = null;
        hideUndoToast();
        refreshURL();
      }

      function attachItemEvents(item){
        item.querySelectorAll('.pill').forEach(pill => {
          const labelEl = pill.querySelector('.label');
          if(labelEl){ setNativeLabelEl(labelEl, pill.dataset.lang); }
          // Inline edit: double-click or right-click to edit the text for this language
          pill.addEventListener('dblclick', (e) => {
            e.preventDefault();
            const label = labelEl ? labelEl.textContent : (pill.dataset.lang || '');
            const current = pill.dataset.text || item.dataset.name || '';
            const next = prompt(`Text for ${label}`, current);
            if(next !== null){
              pill.dataset.text = next.trim();
              const siblingText = pill.parentElement && pill.parentElement.querySelector && pill.parentElement.querySelector('.text');
              if(siblingText){ siblingText.textContent = pill.dataset.text; }
              refreshURL();
            }
          });
          pill.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const label = labelEl ? labelEl.textContent : (pill.dataset.lang || '');
            const current = pill.dataset.text || item.dataset.name || '';
            const next = prompt(`Text for ${label}`, current);
            if(next !== null){
              pill.dataset.text = next.trim();
              const siblingText = pill.parentElement && pill.parentElement.querySelector && pill.parentElement.querySelector('.text');
              if(siblingText){ siblingText.textContent = pill.dataset.text; }
              refreshURL();
            }
          });
          pill.addEventListener('click', async () => {
            const name = item.dataset.name;
            const lang = pill.dataset.lang;
            const text = pill.dataset.text || name;
            // Ensure any previous playback is stopped and UI reset before starting a new one
            stopAllPronunciations();
            // Now set current pill to loading so user sees immediate feedback
            setPillState(pill, 'loading');
            const base = window.location.pathname.endsWith('/') ? window.location.pathname.slice(0,-1) : window.location.pathname;
            const api = base.endsWith('/name') ? '/name/api/pronounce' : '/api/pronounce';
            const url = new URL(api, window.location.origin);
            url.searchParams.set('name', text);
            url.searchParams.set('lang', lang);
            let res, data;
            try {
              res = await fetch(url.toString());
              if(!res.ok) throw new Error(`Server error: ${res.status}`);
              data = await res.json();
            } catch(fetchErr) {
              console.error('Pronunciation fetch failed', fetchErr);
              setPillState(pill, 'error');
              currentPill = null;
              return;
            }
            if(data.type === 'audio' || data.type === 'tts_audio'){
              const key = `${lang}|${text}`;
              const isReplay = playedUrls.has(data.url) || playedKeys.has(key);
              trackPlay({ provider: data.provider, cacheSource: data.cache_source, nameText: text, lang, isReplay });
              playedUrls.add(data.url);
              playedKeys.add(key);

              audio.src = data.url;
              audio.onended = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              audio.onerror = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              try {
                const playPromise = audio.play();
                if (playPromise && typeof playPromise.then === 'function') {
                  playPromise.catch(err => {
                    if (!(err && err.name === 'AbortError')) {
                      console.error('Audio play error', err);
                    }
                    resetPillState(pill);
                    if(currentPill===pill) currentPill=null;
                  });
                }
              } catch (err) {
                if (!(err && err.name === 'AbortError')) {
                  console.error('Audio play threw', err);
                }
                resetPillState(pill);
                if(currentPill===pill) currentPill=null;
              }
              setPillState(pill, data.type === 'audio' ? 'playing-user' : 'playing-robot');
              currentPill = pill;
            }else if(data.type === 'sequence'){
              const urls = data.urls || [];
              trackPlay({ provider: data.provider, cacheSource: null, nameText: text, lang, isReplay: false });
              let idx = 0;
              const playNext = () => {
                if(idx >= urls.length){ resetPillState(pill); if(currentPill===pill) currentPill=null; return; }
                audio.src = urls[idx++];
                audio.onended = playNext;
                audio.onerror = playNext;
                try { audio.play(); } catch(_) { playNext(); }
              };
              setPillState(pill, 'playing-user');
              playNext();
              currentPill = pill;
            }else if(data.type === 'tts'){
              trackPlay({ provider: data.provider || 'browser_tts', cacheSource: 'client', nameText: text, lang, isReplay: true });
              // Stop audio first in case it was playing
              try { audio.pause(); audio.currentTime = 0; } catch(_) {}
              const u = new SpeechSynthesisUtterance(data.text);
              u.lang = data.lang;
              u.onend = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              u.onerror = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              speechSynthesis.cancel();
              speechSynthesis.speak(u);
              setPillState(pill, 'playing-robot');
              currentPill = pill;
            }
          });
        });
        item.querySelector('.remove').addEventListener('click', () => { removeWithUndo(item); });
      }

      addEl.addEventListener('click', () => {
        if(!validateInputs()) return;
        const name = nameInputEl.value.trim();
        if(!name) return;
        const prons = getPronRows().map(row => ({
          text: row.querySelector('input').value.trim(),
          lang: row.querySelector('select').value
        })).filter(p => p.text);
        if(prons.length === 0) return;
        addItem(name, prons);
        // Reset form
        nameInputEl.value = '';
        pronRowsEl.querySelectorAll('.pron-row').forEach(r => r.remove());
        createPronRow('en-US', '', false);
        nameInputEl.focus();
        refreshURL();
        validateInputs();
      });

      // Enter key on name input or pron text fields triggers add
      nameInputEl.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !addEl.disabled){ addEl.click(); }});

      shareEl.addEventListener('click', async () => {
        const url = (shareEl && shareEl.dataset.url) ? shareEl.dataset.url : window.location.href;
        const data = { title: 'Say my name', text: 'Name list', url };
        if (navigator.share) {
          try { await navigator.share(data); } catch(_) { /* ignore */ }
        } else {
          try{
            await navigator.clipboard.writeText(url);
            const lbl = shareEl.querySelector('.label');
            if(lbl){ lbl.textContent = 'Copied'; setTimeout(()=> lbl.textContent = 'Share name list', 1200); }
          }catch(_){
            prompt('Copy link', url);
          }
        }
      });

      // How it works toggle
      // (function(){
      //   const panel = document.getElementById('how');
      //   if(!panel) return;
      //   const head = panel.querySelector('.how-head');
      //   const body = panel.querySelector('.how-body');
      //   head.addEventListener('click', () => {
      //     const open = panel.getAttribute('aria-expanded') === 'true';
      //     panel.setAttribute('aria-expanded', open ? 'false' : 'true');
      //     body.style.display = open ? 'none' : 'block';
      //   });
      // })();

      // footer demo link removed
      // demoEl.addEventListener('click', async (e) => {
      //   e.preventDefault();
      //   const demoUrl = buildDemoUrl();
      //   demoEl.href = demoUrl;
      //   window.open(demoUrl, '_blank', 'noopener');
      // });
      // ... if demoEl exists in cached HTML; otherwise no-op

      // Attach existing items
      document.querySelectorAll('.item').forEach(attachItemEvents);

      // --- Deep Link Handling for Smart App Banner ---
      (function(){
        try {
          const url = new URL(window.location.href);
          const sharedData = url.searchParams.get('s');

          if (sharedData) {
            // Update Smart App Banner with shared data
            const metaTag = document.querySelector('meta[name="apple-itunes-app"]');
            if (metaTag) {
              metaTag.setAttribute('content',
                `app-id=6751617647, app-argument=https://saymyname.qingbo.us/?s=${sharedData}`
              );
            }

            // Only attempt deep linking on mobile devices (iOS/Android)
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            const isAndroid = /android/i.test(userAgent);
            const isMobile = isIOS || isAndroid;

            if (isMobile) {
              // Try to trigger custom scheme URL for direct app opening
              // This creates an invisible iframe that attempts to open the app
              const customSchemeUrl = `saymyname://?s=${sharedData}`;
              const iframe = document.createElement('iframe');
              iframe.style.display = 'none';
              iframe.src = customSchemeUrl;
              document.body.appendChild(iframe);

              // Clean up iframe after attempt
              setTimeout(() => {
                if (iframe.parentNode) {
                  document.body.removeChild(iframe);
                }
              }, 1000);
            }
          }
        } catch (e) {
          // Ignore errors in deep link handling
          console.debug('Deep link handling error:', e);
        }
      })();

      // --- Guided Demo â€” Sandbox Mode ---
      (function(){
        const HIDE_KEY = 'hide_name_guided_demo';
        const SEEN_KEY = 'seen_name_guided_demo';
        let savedState = null;
        let bannerEl = null;

        function typeInto(input, text){
          return new Promise(res => {
            try{ input.focus(); }catch(_){}
            input.value = '';
            let i = 0;
            function tick(){
              if(i <= text.length){
                input.value = text.slice(0, i++);
                input.dispatchEvent(new Event('input', {bubbles:true}));
                setTimeout(tick, 50);
              } else { res(); }
            }
            tick();
          });
        }

        function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

        function makeBanner(stepIdx, total, title, desc){
          if(!bannerEl){
            bannerEl = document.createElement('div');
            bannerEl.id = 'guide-banner';
            bannerEl.style.cssText = 'position:sticky;top:8px;z-index:3000;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:12px 16px;margin-bottom:8px;display:flex;flex-direction:column;gap:8px';
            const container = document.querySelector('.wrap');
            if(container){
              const colBar = document.getElementById('collections-bar');
              container.insertBefore(bannerEl, colBar || container.querySelector('.card') || container.firstChild);
            }
          }
          const dots = Array.from({length:total}, (_,i) => `<span style="width:8px;height:8px;border-radius:50%;background:${i<=stepIdx ? '#4f46e5' : '#c7d2fe'};display:inline-block"></span>`).join('');
          bannerEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:600;font-size:14px;color:#3730a3">${title}</div>
              <button id="guide-exit" style="background:none;border:none;color:#6366f1;font-size:12px;cursor:pointer;padding:4px 8px" aria-label="Exit demo">âœ• Exit</button>
            </div>
            <div style="font-size:13px;color:#4b5563">${desc}</div>
            <div style="display:flex;gap:6px;align-items:center">${dots}</div>
          `;
          const exitBtn = bannerEl.querySelector('#guide-exit');
          if(exitBtn) exitBtn.onclick = () => exitDemo();
        }

        function removeBanner(){
          if(bannerEl){ bannerEl.remove(); bannerEl = null; }
        }

        async function startDemo(){
          try{ localStorage.setItem(SEEN_KEY, '1'); }catch(_){}
          const cta = document.getElementById('guide-cta'); if(cta) cta.remove();
          savedState = getCurrentEntries();
          clearList();
          nameInputEl.value = '';
          const existingRows = document.querySelectorAll('.pron-row');
          existingRows.forEach(r => r.remove());
          createPronRow('en-US', '', false);
          const STEPS = 4;

          makeBanner(0, STEPS, 'Step 1: Type a name', 'Let\'s add "Zhang Wei" to the list');
          await delay(600);
          await typeInto(nameInputEl, 'Zhang Wei');
          await delay(400);

          makeBanner(1, STEPS, 'Step 2: Add a pronunciation', 'Adding a Chinese pronunciation row');
          await delay(400);
          addPronEl.click();
          await delay(300);
          const rows = getPronRows();
          if(rows.length >= 2){
            const lastRow = rows[rows.length - 1];
            const sel = lastRow.querySelector('select');
            const inp = lastRow.querySelector('input');
            if(sel) sel.value = 'zh-CN';
            if(inp) await typeInto(inp, 'å¼ ä¼Ÿ');
          }
          await delay(400);

          makeBanner(2, STEPS, 'Step 3: Add and play', 'Adding to the list, then playing pronunciation');
          await delay(400);
          addEl.click();
          await delay(800);
          const pill = document.querySelector('.item:last-of-type .pill');
          if(pill) pill.click();
          await delay(2000);

          makeBanner(3, STEPS, 'Demo complete!', 'Your names are restored. Try it yourself!');
          await delay(2500);
          exitDemo();
        }

        function exitDemo(){
          removeBanner();
          if(savedState !== null){
            hydrateList(savedState);
            savedState = null;
          }
          refreshURL();
          nameInputEl.value = '';
          const existingRows = document.querySelectorAll('.pron-row');
          existingRows.forEach(r => r.remove());
          createPronRow('en-US', '', false);
          validateInputs();
        }

        function showCTA(){
          try{ if(localStorage.getItem(HIDE_KEY) === '1') return; }catch(_){}
          if(document.getElementById('guide-cta')) return;
          const banner = document.createElement('div');
          banner.id = 'guide-cta';
          banner.style.cssText = 'margin:8px 0 12px;padding:10px 12px;border:1px solid #c7d2fe;background:#eef2ff;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px';
          banner.innerHTML = `
            <div style="font-size:13px;color:#3730a3;font-weight:600">Try the guided demo</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button id="guide-start" style="padding:6px 10px;border-radius:8px;background:#4f46e5;color:#fff;font-size:12px;border:none;cursor:pointer">Start</button>
              <button id="guide-dismiss" style="padding:6px 10px;border-radius:8px;background:#e0e7ff;color:#3730a3;font-size:12px;border:1px solid #c7d2fe;cursor:pointer">Dismiss</button>
            </div>
          `;
          const container = document.querySelector('.wrap');
          if(container){ container.insertBefore(banner, container.querySelector('.card') || container.firstChild); }
          const startBtn = banner.querySelector('#guide-start');
          const dismissBtn = banner.querySelector('#guide-dismiss');
          if(startBtn){ startBtn.onclick = () => startDemo(); }
          if(dismissBtn){ dismissBtn.onclick = () => { try{ localStorage.setItem(HIDE_KEY, '1'); }catch(_){} banner.remove(); }; }
        }

        // Auto-show CTA on first visit (unless hidden or already seen)
        try {
          const u = new URL(window.location.href);
          if(u.searchParams.get('guide') === '1'){ startDemo(); }
          else if(!localStorage.getItem(SEEN_KEY) && !localStorage.getItem(HIDE_KEY) && !u.searchParams.has('s')){
            showCTA();
          }
        } catch(_){ }
      })();
    </script>
  </body>
  </html>
