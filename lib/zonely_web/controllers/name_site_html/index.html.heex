<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Say my name</title>
    <meta name="color-scheme" content="light dark" />

    <!-- Smart App Banner for iOS -->
    <!-- App Store ID: 6751617647 -->
    <meta name="apple-itunes-app" content="app-id=6751617647, app-argument=https://saymyname.qingbo.us/" />
    <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
    <link rel="icon" type="image/svg+xml" href={~p"/favicon.svg?v=3"} />
    <link rel="icon" sizes="any" type="image/svg+xml" href={~p"/favicon.svg?v=3"} />
    <link rel="icon" type="image/png" sizes="32x32" href={~p"/favicon-32x32.png?v=3"} />
    <link rel="apple-touch-icon" sizes="180x180" href={~p"/favicon-32x32.png?v=3"} />
    <style>
      :root{--bg:#ffffff;--fg:#0f172a;--muted:#64748b;--ring:#e2e8f0;--accent:#111827;--card:#f8fafc}
      @media (prefers-color-scheme: dark){:root{--bg:#0b0f17;--fg:#e5e7eb;--muted:#9ca3af;--ring:#111827;--accent:#e5e7eb;--card:#111827}}
      *{box-sizing:border-box}
      html,body{padding:0;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
      a{color:inherit}
      .wrap{max-width:820px;margin:0 auto;padding:24px}
      .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
      .brand{display:flex;align-items:center;gap:10px}
      .logo{width:28px;height:28px}
      .title{font-size:18px;font-weight:600;letter-spacing:0.2px}
      .card{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:16px}
      .row{display:flex;gap:12px;align-items:center}
      .input{flex:1;display:flex;gap:8px}
      input,select{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px;background:transparent;color:inherit}
      button{appearance:none;border:1px solid var(--ring);background:transparent;color:inherit;border-radius:10px;padding:10px 14px;cursor:pointer}
      button.primary{background:var(--accent);color:var(--bg);border-color:var(--accent)}
      .list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
      .item{display:grid;grid-template-columns:64px 1fr auto;align-items:start;column-gap:12px;row-gap:8px;border:1px solid var(--ring);border-radius:12px;padding:10px}
      .avatar{width:64px;height:64px;border-radius:50%;overflow:hidden;border:1px solid var(--ring);grid-column:1;grid-row:1 / span 2}
      .name{font-weight:600;line-height:1.2;grid-column:2;grid-row:1}
      .langs{display:flex;gap:16px;align-items:center;flex-wrap:wrap;grid-column:2;grid-row:2}
      .item > .remove{grid-column:3;grid-row:1;align-self:start}
      .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;color:var(--muted)}
      .pill.playing-user{background:#ecfdf5;color:#059669;border-color:#a7f3d0}
      .pill.playing-robot{background:#fff7ed;color:#ea580c;border-color:#fed7aa}
      .pill.animate{animation:pulse 1s ease-in-out infinite}
      .pill.loading{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;animation:breath 1.2s ease-in-out infinite}
      @keyframes breath{0%{background:#eff6ff}50%{background:#dbeafe}100%{background:#eff6ff}}
      .icon.spin{animation:spin 0.9s linear infinite;transform-origin:50% 50%}
      @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
      .entry{display:flex;align-items:center;gap:8px}
      .text{font-weight:600;color:var(--fg)}
      @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
      .empty{color:var(--muted);text-align:center;padding:28px}
      .footer{margin-top:24px;padding-top:16px;border-top:1px solid var(--ring)}
      .footer-actions{display:flex;gap:10px;justify-content:space-between;align-items:center}
      .site-links{font-size:12px;opacity:.7;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
      .muted{color:var(--muted)}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
      /* Stylish copy button */
      #share{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:none;border-radius:999px;background:#4f46e5;color:#fff;box-shadow:0 10px 20px rgba(79,70,229,.25);font-weight:600}
      #share:hover{background:#4338ca}
      #share:active{transform:translateY(1px)}
      #share .icon{width:16px;height:16px}
      /* Mobile tweaks */
      @media (max-width: 640px){
        .wrap{padding:16px}
        .title{font-size:16px}
        .row{flex-direction:column;align-items:stretch;gap:10px}
        .input{flex-direction:column}
        input,select{width:100%}
        button.primary{width:100%}
        .item{padding:8px;grid-template-columns:48px 1fr auto}
        .avatar{width:48px;height:48px}
        .langs{gap:10px}
        .entry{gap:6px}
        .pill{padding:6px 10px}
        .text{font-size:0.95rem}
        .footer{flex-direction:column;align-items:stretch;gap:8px}
        #share,#demo{width:100%}
      }
      /* How it works collapsible */
      .how{margin-top:12px;border:1px solid var(--ring);border-radius:10px}
      .how-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
      .how-title{font-weight:600}
      .chev{transition:transform .2s ease}
      .how[aria-expanded="true"] .chev{transform:rotate(90deg)}
      .how-body{padding:10px 12px;padding-top:0;color:var(--muted)}
      /* Inline validation without layout shift */
      .field{position:relative}
      .hint{position:absolute;left:10px;bottom:-16px;height:14px;font-size:11px;color:#f59e0b;opacity:0;pointer-events:none;}
      .field.show-hint .hint{opacity:1}
      input.invalid, select.invalid{
        border-color:#f59e0b !important;
        box-shadow: inset 0 0 0 1px #f59e0b, 0 0 0 3px rgba(245,158,11,0.25);
        background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23f59e0b'%3E%3Cpath fill-rule='evenodd' d='M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.516 11.59c.75 1.335-.214 2.99-1.743 2.99H3.484c-1.53 0-2.494-1.655-1.743-2.99L8.257 3.1zM9 7h2v5H9V7zm0 6h2v2H9v-2z' clip-rule='evenodd'/%3E%3C/svg%3E");
        background-repeat:no-repeat; background-position:right 10px center; background-size:14px;
        padding-right:28px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="brand">
          <img class="logo" src={~p"/favicon-32x32.png?v=3"} alt="Say my name" />
          <div class="title">Say my name</div>
        </div>
        <div>
          <button id="share" aria-label="Share name list" class="primary">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M13 7H7a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM5 9a2 2 0 0 1 2-2h.5V6A2.5 2.5 0 0 1 10 3.5h0A2.5 2.5 0 0 1 12.5 6V7H7.5V6Z" fill-opacity=".15"/><path d="M7.5 6V6A2.5 2.5 0 0 1 10 3.5h0A2.5 2.5 0 0 1 12.5 6V7H7.5V6Z"/></svg>
            <span class="label">Share name list</span>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="input">
            <div class="field" id="field_en">
              <input id="text_en" placeholder="Name for English (e.g., San Zhang)" />
              <div class="hint" id="hint_en">Text may not match English</div>
            </div>
            <div class="field" id="field_en_lang">
              <select id="lang_en">
              <option value="en-US" selected>English</option>
              <option value="es-ES">Español</option>
              <option value="fr-FR">Français</option>
              <option value="de-DE">Deutsch</option>
              <option value="pt-BR">Português</option>
              <option value="zh-CN">中文</option>
              <option value="ja-JP">日本語</option>
              <option value="hi-IN">हिन्दी</option>
              <option value="bn-IN">বাংলা</option>
              <option value="ar-SA">العربية</option>
              </select>
            </div>
            <span aria-hidden="true" style="align-self:center;color:var(--muted);">—</span>
            <div class="field" id="field_zh">
              <input id="text_zh" placeholder="Name for native language (e.g., 张三)" />
              <div class="hint" id="hint_zh">Text may not match native</div>
            </div>
            <div class="field" id="field_zh_lang">
              <select id="lang_zh">
              <option value="en-US">English</option>
              <option value="es-ES">Español</option>
              <option value="fr-FR">Français</option>
              <option value="de-DE">Deutsch</option>
              <option value="pt-BR">Português</option>
              <option value="zh-CN" selected>中文</option>
              <option value="ja-JP">日本語</option>
              <option value="hi-IN">हिन्दी</option>
              <option value="bn-IN">বাংলা</option>
              <option value="ar-SA">العربية</option>
              </select>
            </div>

          </div>
          <button id="add" class="primary">Add</button>
        </div>

        <div class="list" id="list">
          <%= if @names == [] do %>
            <div class="empty">No names yet. Add a name and language to begin.</div>
          <% end %>
          <%= for item <- @names do %>
            <div class="item" data-name={item.name}>
              <img class="avatar" src={item.avatar} alt="" />
              <div class="name"><%= item.name %></div>
              <div class="langs">
                <%= for e <- item.entries || [] do %>
                  <div class="entry">
                    <button class="pill" data-lang={e.lang} data-text={e.text}>
                      <span class="label"></span>
                      <svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    </button>
                    <span class="text"><%= e.text %></span>
                  </div>
                <% end %>
              </div>
              <button class="remove" title="Remove">✕</button>
            </div>
          <% end %>
        </div>



        <div class="footer">
          <div class="muted site-links">
            <a href={~p"/privacy"} class="muted" style="text-decoration:underline">Privacy</a>
            <span aria-hidden="true">·</span>
            <a href={~p"/about"} class="muted" style="text-decoration:underline">About</a>
          </div>
        </div>
      </div>
    </div>

    <audio id="audio" preload="none"></audio>

    <script>
      const listEl = document.getElementById('list');
      const audio = document.getElementById('audio');
      const textEnEl = document.getElementById('text_en');
      const textZhEl = document.getElementById('text_zh');
      const langEnEl = document.getElementById('lang_en');
      const langZhEl = document.getElementById('lang_zh');
      const addEl = document.getElementById('add');
      const shareEl = document.getElementById('share');
      const demoEl = document.getElementById('demo');
      const supportedLangs = ["en-US","es-ES","fr-FR","de-DE","pt-BR","zh-CN","ja-JP","hi-IN","bn-IN","ar-SA"];
      const playedUrls = new Set();
      const playedKeys = new Set();

      async function trackPlay({ provider, cacheSource, nameText, lang, isReplay }) {
        try {
          const body = {
            provider: isReplay ? 'cache_client' : (cacheSource ? `cache_${cacheSource}` : (provider || 'unknown')),
            cache_source: isReplay ? 'client' : (cacheSource || null),
            original_provider: provider || 'unknown',
            name_text: nameText,
            lang,
            platform: 'web'
          };

          await fetch('/api/analytics/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        } catch (_) {}
      }

      // Lightweight script-based language check (same set as iOS)
      function allowedScripts(code){
        const base = (code||'').split('-')[0].toLowerCase();
        switch(base){
          case 'en': case 'es': case 'fr': case 'de': case 'it': case 'pt': case 'vi': case 'id': case 'nl': case 'sv': case 'no': case 'da': case 'fi': case 'pl': case 'cs': case 'ro': case 'tr':
            return ['latin'];
          case 'zh': return ['cjk'];
          case 'ja': return ['hiragana','katakana','cjk'];
          case 'ko': return ['hangul'];
          case 'ru': case 'uk': case 'bg': case 'sr': return ['cyrillic'];
          case 'ar': case 'fa': case 'ur': return ['arabic'];
          case 'hi': return ['devanagari'];
          case 'th': return ['thai'];
          default: return ['latin','cjk','hiragana','katakana','hangul','cyrillic','arabic','devanagari','thai'];
        }
      }
      function scriptOfScalar(cp){
        if((cp>=0x41&&cp<=0x7A)||(cp>=0xC0&&cp<=0x24F)||(cp>=0x1E00&&cp<=0x1EFF)) return 'latin';
        if((cp>=0x4E00&&cp<=0x9FFF)||(cp>=0x3400&&cp<=0x4DBF)||(cp>=0xF900&&cp<=0xFAFF)) return 'cjk';
        if(cp>=0x3040&&cp<=0x309F) return 'hiragana';
        if((cp>=0x30A0&&cp<=0x30FF)||(cp>=0x31F0&&cp<=0x31FF)) return 'katakana';
        if((cp>=0xAC00&&cp<=0xD7AF)||(cp>=0x1100&&cp<=0x11FF)||(cp>=0x3130&&cp<=0x318F)) return 'hangul';
        if((cp>=0x0400&&cp<=0x04FF)||(cp>=0x0500&&cp<=0x052F)) return 'cyrillic';
        if((cp>=0x0600&&cp<=0x06FF)||(cp>=0x0750&&cp<=0x077F)||(cp>=0x08A0&&cp<=0x08FF)) return 'arabic';
        if(cp>=0x0900&&cp<=0x097F) return 'devanagari';
        if(cp>=0x0E00&&cp<=0x0E7F) return 'thai';
        return 'unknown';
      }
      function dominantScript(str){
        const counts={};
        for(const ch of str){ const s=scriptOfScalar(ch.codePointAt(0)); if(s!=='unknown'){ counts[s]=(counts[s]||0)+1; } }
        let best=null, max=0; for(const k in counts){ if(counts[k]>max){ max=counts[k]; best=k; } }
        return best;
      }
      function matchesTextToLang(text, lang){
        const t = (text||'').trim(); if(!t) return true;
        if(!supportedLangs.includes(lang)) return true;
        const dom = dominantScript(t); if(!dom) return true;
        return allowedScripts(lang).includes(dom) || dom==='unknown';
      }
      function toggleInvalid(el, flag){ el.classList.toggle('invalid', !!flag); }
      function validateInputs(){
        const en = textEnEl.value.trim();
        const zh = textZhEl.value.trim();
        const le = langEnEl.value; const lz = langZhEl.value;
        const enMismatch = en && !matchesTextToLang(en, le);
        const zhMismatch = zh && !matchesTextToLang(zh, lz);
        toggleInvalid(textEnEl, enMismatch); toggleInvalid(langEnEl, enMismatch);
        toggleInvalid(textZhEl, zhMismatch); toggleInvalid(langZhEl, zhMismatch);
        addEl.disabled = enMismatch || zhMismatch || (!en && !zh);
        const map = {"en-US":"English","zh-CN":"中文","es-ES":"Español","hi-IN":"हिन्दी","ar-SA":"العربية","bn-IN":"বাংলা","fr-FR":"Français","pt-BR":"Português","ja-JP":"日本語","de-DE":"Deutsch"};
        const hintEn = document.getElementById('hint_en');
        const hintZh = document.getElementById('hint_zh');
        if(hintEn){ hintEn.textContent = `Text may not match ${map[le]||le}`; hintEn.style.opacity = enMismatch ? '1' : '0'; }
        if(hintZh){ hintZh.textContent = `Text may not match ${map[lz]||lz}`; hintZh.style.opacity = zhMismatch ? '1' : '0'; }
        return !(enMismatch || zhMismatch);
      }
      [textEnEl, textZhEl].forEach(el=>{
        el.addEventListener('input', validateInputs);
        el.addEventListener('blur', validateInputs);
      });
      [langEnEl, langZhEl].forEach(el=>{
        el.addEventListener('change', validateInputs);
        el.addEventListener('blur', validateInputs);
      });
      validateInputs();
      // Unicode-safe Base64 URL helpers (for names with non-Latin chars)
      function utf8ToB64(str){
        const bytes = new TextEncoder().encode(str);
        let bin = '';
        for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
        return btoa(bin);
      }
      function b64ToUtf8(b64){
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }
      function b64UrlEncode(str){
        return utf8ToB64(str).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
      }
      function b64UrlDecode(str){
        const pad = str.length % 4 === 2 ? '==' : (str.length % 4 === 3 ? '=' : '');
        const b64 = str.replace(/-/g,'+').replace(/_/g,'/') + pad;
        return b64ToUtf8(b64);
      }
      function buildDemoUrl(){
        const demo = [
          { name: '王明', entries: [
            { lang: 'en-US', text: 'Ming Wang' },
            { lang: 'zh-CN', text: '王明' }
          ]},
          { name: 'Maria Silva', entries: [
            { lang: 'pt-BR', text: 'Maria Silva' },
            { lang: 'en-US', text: 'Maria Silva' }
          ]},
          { name: 'Ravi Kumar', entries: [
            { lang: 'hi-IN', text: 'रवि कुमार' },
            { lang: 'en-US', text: 'Ravi Kumar' }
          ]},
          { name: 'Ana García', entries: [
            { lang: 'es-ES', text: 'Ana García' },
            { lang: 'en-US', text: 'Ana Garcia' }
          ]},
          { name: 'François Dupont', entries: [
            { lang: 'fr-FR', text: 'François Dupont' },
            { lang: 'en-US', text: 'Francois Dupont' }
          ]},
          { name: 'Jürgen Müller', entries: [
            { lang: 'de-DE', text: 'Jürgen Müller' },
            { lang: 'en-US', text: 'Juergen Mueller' }
          ]},
          { name: 'Ahmed Ali', entries: [
            { lang: 'ar-SA', text: 'أحمد علي' },
            { lang: 'en-US', text: 'Ahmed Ali' }
          ]},
          { name: 'Yuki Tanaka', entries: [
            { lang: 'ja-JP', text: '田中 友紀' },
            { lang: 'en-US', text: 'Yuki Tanaka' }
          ]}
        ];
        const json = JSON.stringify(demo);
        const s = b64UrlEncode(json);
        const url = new URL(window.location.href);
        url.searchParams.set('s', s);
        return url.toString();
      }

      // footer demo link removed; keep fallback for cached pages
      if (demoEl) {
        demoEl.href = buildDemoUrl();
      }

      // Cookie helpers for state persistence
      function setStateCookie(s){
        try{
          if(!s){ document.cookie = 'names_state=; Max-Age=0; path=/; SameSite=Lax'; return; }
          document.cookie = `names_state=${s}; Max-Age=31536000; path=/; SameSite=Lax`;
        }catch(_){ }
      }
      function getStateCookie(){
        try{
          const m = document.cookie.match(/(?:^|; )names_state=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : null;
        }catch(_){ return null; }
      }

      // If no URL state, try cookie state and hydrate via redirect
      (function(){
        try{
          const url = new URL(window.location.href);
          const hasS = url.searchParams.has('s');
          if(!hasS){
            const cs = getStateCookie();
            if(cs){
              url.searchParams.set('s', cs);
              window.location.replace(url.toString());
              return;
            }
          }
        }catch(_){ }
      })();
      function encodeState(items){
        const data = items.map(el => ({
          name: el.dataset.name,
          entries: [...el.querySelectorAll('.pill')].map(p=>({lang: p.dataset.lang, text: p.dataset.text || el.dataset.name}))
        }));
        const json = JSON.stringify(data);
        return b64UrlEncode(json);
      }

      function decodeState(s){
        try{
          const json = b64UrlDecode(s);
          return JSON.parse(json);
        }catch(_){ return []; }
      }

      function setNativeLabelEl(el, lang){
        const map = {"en-US":"English","zh-CN":"中文","es-ES":"Español","hi-IN":"हिन्दी","ar-SA":"العربية","bn-IN":"বাংলা","fr-FR":"Français","pt-BR":"Português","ja-JP":"日本語","de-DE":"Deutsch"};
        const label = map[lang] || lang;
        el.textContent = label;
        const pill = el.closest('.pill');
        if(pill){ pill.title = `${label} — double-click to edit text`; }
      }

      function refreshURL(){
        const items = [...listEl.querySelectorAll('.item')];
        const s = encodeState(items);
        const url = new URL(window.location.href);
        if(s && s.length>0){ url.searchParams.set('s', s); }
        else { url.searchParams.delete('s'); }
        history.replaceState(null, '', url.toString());
        // Update visible deep-link button
        const share = document.getElementById('share');
        if(share){ share.dataset.url = url.toString(); }
        // Persist to cookie
        setStateCookie(s || '');
      }

      function avatarFor(name){
        const seed = name.toLowerCase().replace(/[^\w\s]/g,'').replace(/\s+/g,'-');
        return `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9&size=48`;
      }

      function addItem(enText, zhText, langEn, langZh){
        if(!enText && !zhText) return;
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.name = zhText || enText || '';
        el.innerHTML = `
          <img class="avatar" src="${avatarFor(zhText || enText || '')}" alt="" />
          <div class="name"></div>
          <div class="langs"></div>
          <button class="remove" title="Remove">✕</button>`;
        el.querySelector('.name').textContent = zhText || enText || '';

        // Only add the languages the user actually typed
        if(enText){
          const entryEn = document.createElement('div');
          entryEn.className = 'entry';
          const pillEn = document.createElement('button');
          pillEn.className = 'pill';
          pillEn.dataset.lang = langEn || 'en-US';
          pillEn.dataset.text = enText;
          pillEn.innerHTML = `<span class="label"></span> <svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
          entryEn.appendChild(pillEn);
          const textSpanEn = document.createElement('span');
          textSpanEn.className = 'text';
          textSpanEn.textContent = pillEn.dataset.text;
          entryEn.appendChild(textSpanEn);
          el.querySelector('.langs').appendChild(entryEn);
          setNativeLabelEl(pillEn.querySelector('.label'), pillEn.dataset.lang);
        }

        if(zhText){
          const entryZh = document.createElement('div');
          entryZh.className = 'entry';
          const pillZh = document.createElement('button');
          pillZh.className = 'pill';
          pillZh.dataset.lang = langZh || 'zh-CN';
          pillZh.dataset.text = zhText;
          pillZh.innerHTML = `<span class=\"label\"></span> <svg class=\"icon\" width=\"16\" height=\"16\" viewBox=\"0 0 20 20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z\" clip-rule=\"evenodd\"></path></svg>`;
          entryZh.appendChild(pillZh);
          const textSpanZh = document.createElement('span');
          textSpanZh.className = 'text';
          textSpanZh.textContent = pillZh.dataset.text;
          entryZh.appendChild(textSpanZh);
          el.querySelector('.langs').appendChild(entryZh);
          setNativeLabelEl(pillZh.querySelector('.label'), pillZh.dataset.lang);
        }

        listEl.appendChild(el);
        attachItemEvents(el);
        const empty = listEl.querySelector('.empty'); if(empty) empty.remove();
        refreshURL();
      }

      let currentPill = null;

      function setPillState(pill, state){
        pill.classList.remove('playing','loading','playing-user','playing-robot','animate');
        const icon = pill.querySelector('svg');
        if(state==='loading'){
          pill.classList.add('loading');
          if(icon){
            icon.outerHTML = '<svg class="icon spin" width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" opacity="0.25"/><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
          }
        }else if(state==='playing-user'){
          pill.classList.add('playing-user','animate');
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>';
        }else if(state==='playing-robot'){
          pill.classList.add('playing-robot','animate');
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C13.1 2 14 2.9 14 4V6H16C17.1 6 18 6.9 18 8V18C18 19.1 17.1 20 16 20H8C6.9 20 6 19.1 6 18V8C6 6.9 6.9 6 8 6H10V4C10 2.9 10.9 2 12 2ZM12 4C11.4 4 11 4.4 11 5V6H13V5C13 4.4 12.6 4 12 4ZM9 10C8.4 10 8 10.4 8 11S8.4 12 9 12 10 11.6 10 11 9.6 10 9 10ZM15 10C14.4 10 14 10.4 14 11S14.4 12 15 12 16 11.6 16 11 15.6 10 15 10ZM8 14H16V16H8V14Z"/></svg>';
        }else{
          icon.outerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>';
        }
      }

      function resetPillState(pill){ setPillState(pill, 'idle'); }

      function stopAllPronunciations(){
        try { audio.pause(); audio.currentTime = 0; } catch(_){ }
        try { if (window.speechSynthesis) speechSynthesis.cancel(); } catch(_){ }
        document.querySelectorAll('.pill.playing-user, .pill.playing-robot, .pill.loading')
          .forEach(p => setPillState(p, 'idle'));
        currentPill = null;
      }

      function attachItemEvents(item){
        item.querySelectorAll('.pill').forEach(pill => {
          const labelEl = pill.querySelector('.label');
          if(labelEl){ setNativeLabelEl(labelEl, pill.dataset.lang); }
          // Inline edit: double-click or right-click to edit the text for this language
          pill.addEventListener('dblclick', (e) => {
            e.preventDefault();
            const label = labelEl ? labelEl.textContent : (pill.dataset.lang || '');
            const current = pill.dataset.text || item.dataset.name || '';
            const next = prompt(`Text for ${label}`, current);
            if(next !== null){
              pill.dataset.text = next.trim();
              const siblingText = pill.parentElement && pill.parentElement.querySelector && pill.parentElement.querySelector('.text');
              if(siblingText){ siblingText.textContent = pill.dataset.text; }
              refreshURL();
            }
          });
          pill.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const label = labelEl ? labelEl.textContent : (pill.dataset.lang || '');
            const current = pill.dataset.text || item.dataset.name || '';
            const next = prompt(`Text for ${label}`, current);
            if(next !== null){
              pill.dataset.text = next.trim();
              const siblingText = pill.parentElement && pill.parentElement.querySelector && pill.parentElement.querySelector('.text');
              if(siblingText){ siblingText.textContent = pill.dataset.text; }
              refreshURL();
            }
          });
          pill.addEventListener('click', async () => {
            const name = item.dataset.name;
            const lang = pill.dataset.lang;
            const text = pill.dataset.text || name;
            // Ensure any previous playback is stopped and UI reset before starting a new one
            stopAllPronunciations();
            // Now set current pill to loading so user sees immediate feedback
            setPillState(pill, 'loading');
            const base = window.location.pathname.endsWith('/') ? window.location.pathname.slice(0,-1) : window.location.pathname;
            const api = base.endsWith('/name') ? '/name/api/pronounce' : '/api/pronounce';
            const url = new URL(api, window.location.origin);
            url.searchParams.set('name', text);
            url.searchParams.set('lang', lang);
            const res = await fetch(url.toString());
            const data = await res.json();
            if(data.type === 'audio' || data.type === 'tts_audio'){
              const key = `${lang}|${text}`;
              const isReplay = playedUrls.has(data.url) || playedKeys.has(key);
              trackPlay({ provider: data.provider, cacheSource: data.cache_source, nameText: text, lang, isReplay });
              playedUrls.add(data.url);
              playedKeys.add(key);

              audio.src = data.url;
              audio.onended = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              audio.onerror = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              try {
                const playPromise = audio.play();
                if (playPromise && typeof playPromise.then === 'function') {
                  playPromise.catch(err => {
                    if (!(err && err.name === 'AbortError')) {
                      console.error('Audio play error', err);
                    }
                    resetPillState(pill);
                    if(currentPill===pill) currentPill=null;
                  });
                }
              } catch (err) {
                if (!(err && err.name === 'AbortError')) {
                  console.error('Audio play threw', err);
                }
                resetPillState(pill);
                if(currentPill===pill) currentPill=null;
              }
              setPillState(pill, data.type === 'audio' ? 'playing-user' : 'playing-robot');
              currentPill = pill;
            }else if(data.type === 'sequence'){
              const urls = data.urls || [];
              trackPlay({ provider: data.provider, cacheSource: null, nameText: text, lang, isReplay: false });
              let idx = 0;
              const playNext = () => {
                if(idx >= urls.length){ resetPillState(pill); if(currentPill===pill) currentPill=null; return; }
                audio.src = urls[idx++];
                audio.onended = playNext;
                audio.onerror = playNext;
                try { audio.play(); } catch(_) { playNext(); }
              };
              setPillState(pill, 'playing-user');
              playNext();
              currentPill = pill;
            }else if(data.type === 'tts'){
              trackPlay({ provider: data.provider || 'browser_tts', cacheSource: 'client', nameText: text, lang, isReplay: true });
              // Stop audio first in case it was playing
              try { audio.pause(); audio.currentTime = 0; } catch(_) {}
              const u = new SpeechSynthesisUtterance(data.text);
              u.lang = data.lang;
              u.onend = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              u.onerror = () => { resetPillState(pill); if(currentPill===pill) currentPill=null; };
              speechSynthesis.cancel();
              speechSynthesis.speak(u);
              setPillState(pill, 'playing-robot');
              currentPill = pill;
            }
          });
        });
        item.querySelector('.remove').addEventListener('click', () => { item.remove(); refreshURL(); });
      }

      addEl.addEventListener('click', () => {
        if(!validateInputs()) return;
        const en = textEnEl.value.trim();
        const zh = textZhEl.value.trim();
        const langEn = langEnEl.value;
        const langZh = langZhEl.value;
        addItem(en, zh, langEn, langZh);
        textEnEl.value = '';
        textZhEl.value = '';
        textEnEl.focus();
        refreshURL();
        validateInputs();
      });

      [textEnEl, textZhEl].forEach(inp => inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addEl.click(); }}));

      shareEl.addEventListener('click', async () => {
        const url = (shareEl && shareEl.dataset.url) ? shareEl.dataset.url : window.location.href;
        const data = { title: 'Say my name', text: 'Name list', url };
        if (navigator.share) {
          try { await navigator.share(data); } catch(_) { /* ignore */ }
        } else {
          try{
            await navigator.clipboard.writeText(url);
            const lbl = shareEl.querySelector('.label');
            if(lbl){ lbl.textContent = 'Copied'; setTimeout(()=> lbl.textContent = 'Share name list', 1200); }
          }catch(_){
            prompt('Copy link', url);
          }
        }
      });

      // How it works toggle
      // (function(){
      //   const panel = document.getElementById('how');
      //   if(!panel) return;
      //   const head = panel.querySelector('.how-head');
      //   const body = panel.querySelector('.how-body');
      //   head.addEventListener('click', () => {
      //     const open = panel.getAttribute('aria-expanded') === 'true';
      //     panel.setAttribute('aria-expanded', open ? 'false' : 'true');
      //     body.style.display = open ? 'none' : 'block';
      //   });
      // })();

      // footer demo link removed
      // demoEl.addEventListener('click', async (e) => {
      //   e.preventDefault();
      //   const demoUrl = buildDemoUrl();
      //   demoEl.href = demoUrl;
      //   window.open(demoUrl, '_blank', 'noopener');
      // });
      // ... if demoEl exists in cached HTML; otherwise no-op

      // Attach existing items
      document.querySelectorAll('.item').forEach(attachItemEvents);

      // --- Deep Link Handling for Smart App Banner ---
      (function(){
        try {
          const url = new URL(window.location.href);
          const sharedData = url.searchParams.get('s');

          if (sharedData) {
            // Update Smart App Banner with shared data
            const metaTag = document.querySelector('meta[name="apple-itunes-app"]');
            if (metaTag) {
              metaTag.setAttribute('content',
                `app-id=6751617647, app-argument=https://saymyname.qingbo.us/?s=${sharedData}`
              );
            }

            // Try to trigger custom scheme URL for direct app opening
            // This creates an invisible iframe that attempts to open the app
            const customSchemeUrl = `saymyname://?s=${sharedData}`;
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = customSchemeUrl;
            document.body.appendChild(iframe);



            // Clean up iframe after attempt
            setTimeout(() => {
              if (iframe.parentNode) {
                document.body.removeChild(iframe);
              }
            }, 1000);
          }
        } catch (e) {
          // Ignore errors in deep link handling
          console.debug('Deep link handling error:', e);
        }
      })();

      // --- Guided Demo Overlay ---
      (function(){
        const guided = null; // legacy link removed; use banner CTA instead
        const HIDE_KEY = 'hide_name_guided_demo';
        const SEEN_KEY = 'seen_name_guided_demo';
        const BASE = 1.4; // slow down steps slightly for clarity

        function makeOverlay(){
          const wrap = document.createElement('div');
          wrap.id = 'guide-overlay';
          wrap.style.position = 'sticky';
          wrap.style.top = '8px';
          wrap.style.zIndex = '3000';
          wrap.style.width = '100%';
          wrap.style.maxWidth = '720px';
          wrap.style.background = '#ffffff';
          wrap.style.border = '1px solid #e5e7eb';
          wrap.style.borderRadius = '12px';
          wrap.style.boxShadow = '0 18px 36px rgba(0,0,0,0.18)';
          wrap.style.padding = '12px';
          wrap.innerHTML = `
            <div style="font-weight:600; font-size:14px; color:#111827" id="guide-title">Guided Demo</div>
            <div style="font-size:13px; color:#4b5563; margin-top:6px" id="guide-desc">Follow along</div>
            <div style="height:6px; background:#f3f4f6; border-radius:999px; overflow:hidden; margin:8px 0 10px">
              <div id="guide-progress" style="height:100%; width:0%; background:#6366f1; transition:width .25s"></div>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap">
              <button id="guide-toggle" style="padding:6px 10px; border-radius:8px; background:#111827; color:#ffffff; font-size:12px">Pause</button>
              <button id="guide-skip" style="padding:6px 10px; border-radius:8px; background:#374151; color:#ffffff; font-size:12px">Skip</button>
              <button id="guide-replay" style="padding:6px 10px; border-radius:8px; background:#374151; color:#ffffff; font-size:12px">Replay</button>
            </div>
          `;
          const container = document.querySelector('.wrap') || document.body;
          container.insertBefore(wrap, container.children[1] || null);

          // Highlight box
          const hi = document.createElement('div');
          hi.id = 'guide-highlight';
          hi.style.position = 'fixed';
          hi.style.border = '3px solid #6366f1';
          hi.style.borderRadius = '10px';
          hi.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.35)';
          hi.style.pointerEvents = 'none';
          hi.style.zIndex = '2999';
          hi.style.display = 'none';
          document.body.appendChild(hi);
          return wrap;
        }

        function setHighlight(selector){
          const hi = document.getElementById('guide-highlight');
          if(!hi) return;
          const el = selector && document.querySelector(selector);
          if(!el){ hi.style.display='none'; return; }
          const r = el.getBoundingClientRect();
          hi.style.left = (r.left - 8) + 'px';
          hi.style.top = (r.top - 8) + 'px';
          hi.style.width = (r.width + 16) + 'px';
          hi.style.height = (r.height + 16) + 'px';
          hi.style.display = 'block';
        }

        function typeInto(input, text, onDone){
          try{ input.focus(); }catch(_){ }
          input.value = '';
          let i = 0;
          function tick(){
            if(i <= text.length){ input.value = text.slice(0, i++); setTimeout(tick, 40); }
            else { onDone && onDone(); }
          }
          tick();
        }

        function progress(stepIdx, total){
          const bar = document.getElementById('guide-progress');
          if(bar){ bar.style.width = Math.min(100, Math.round(stepIdx / Math.max(1,total-1) * 100)) + '%'; }
        }

        const steps = [
          { title: 'Enter English name', desc: 'Type the English rendering of the name', selector: '#text_en', run: async () => new Promise(res=> typeInto(textEnEl, 'Ming Wang', res)), delay: 400 },
          { title: 'Choose language', desc: 'Pick the language for this text (English)', selector: '#lang_en', run: async () => { langEnEl.value = 'en-US'; }, delay: 400 },
          { title: 'Enter native name', desc: 'Now type the native script name', selector: '#text_zh', run: async () => new Promise(res=> typeInto(textZhEl, '王明', res)), delay: 400 },
          { title: 'Choose native language', desc: 'Set the correct native language', selector: '#lang_zh', run: async () => { langZhEl.value = 'zh-CN'; }, delay: 400 },
          { title: 'Add to list', desc: 'Click Add to create the entry', selector: '#add', run: async () => { addEl.click(); }, delay: 600 },
          { title: 'Play English pronunciation', desc: 'Click to hear the English version', selector: '.item:last-of-type .pill[data-lang="en-US"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="en-US"]'); if(p) p.click(); }, delay: 1500 },
          { title: 'Play native pronunciation', desc: 'Now the native version', selector: '.item:last-of-type .pill[data-lang="zh-CN"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="zh-CN"]'); if(p) p.click(); }, delay: 1500 },
          { title: 'Add another name', desc: 'Repeat: another row with two languages', selector: '#text_en', run: async () => new Promise(res=> typeInto(textEnEl, 'Ana Garcia', res)), delay: 300 },
          { title: 'Set English', desc: 'Keep English here', selector: '#lang_en', run: async () => { langEnEl.value = 'en-US'; }, delay: 200 },
          { title: 'Enter native', desc: 'Use accents in native language', selector: '#text_zh', run: async () => new Promise(res=> typeInto(textZhEl, 'Ana García', res)), delay: 300 },
          { title: 'Set Spanish', desc: 'Choose Español for native', selector: '#lang_zh', run: async () => { langZhEl.value = 'es-ES'; }, delay: 200 },
          { title: 'Add row', desc: 'Click Add', selector: '#add', run: async () => { addEl.click(); }, delay: 600 },
          { title: 'Play Spanish', desc: 'Play native (Spanish) pronunciation', selector: '.item:last-of-type .pill[data-lang="es-ES"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="es-ES"]'); if(p) p.click(); }, delay: 1500 },
          { title: 'Play English', desc: 'Play English pronunciation', selector: '.item:last-of-type .pill[data-lang="en-US"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="en-US"]'); if(p) p.click(); }, delay: 1500 },
          // Hindi name
          { title: 'Add Hindi example', desc: 'Type English rendering', selector: '#text_en', run: async () => new Promise(res=> typeInto(textEnEl, 'Ravi Kumar', res)), delay: 400 },
          { title: 'Keep English', desc: 'English text is set', selector: '#lang_en', run: async () => { langEnEl.value = 'en-US'; }, delay: 300 },
          { title: 'Type native Hindi', desc: 'Use Devanagari script', selector: '#text_zh', run: async () => new Promise(res=> typeInto(textZhEl, 'रवि कुमार', res)), delay: 400 },
          { title: 'Choose Hindi', desc: 'Set native language to Hindi', selector: '#lang_zh', run: async () => { langZhEl.value = 'hi-IN'; }, delay: 300 },
          { title: 'Add row', desc: 'Click Add', selector: '#add', run: async () => { addEl.click(); }, delay: 700 },
          { title: 'Play Hindi', desc: 'Play native Hindi pronunciation', selector: '.item:last-of-type .pill[data-lang="hi-IN"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="hi-IN"]'); if(p) p.click(); }, delay: 1600 },
          { title: 'Play English', desc: 'Play English pronunciation', selector: '.item:last-of-type .pill[data-lang="en-US"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="en-US"]'); if(p) p.click(); }, delay: 1600 },
          // Arabic name
          { title: 'Add Arabic example', desc: 'Type English rendering', selector: '#text_en', run: async () => new Promise(res=> typeInto(textEnEl, 'Ahmed Ali', res)), delay: 400 },
          { title: 'Keep English', desc: 'English text is set', selector: '#lang_en', run: async () => { langEnEl.value = 'en-US'; }, delay: 300 },
          { title: 'Type native Arabic', desc: 'Use Arabic script', selector: '#text_zh', run: async () => new Promise(res=> typeInto(textZhEl, 'أحمد علي', res)), delay: 400 },
          { title: 'Choose Arabic', desc: 'Set native language to Arabic', selector: '#lang_zh', run: async () => { langZhEl.value = 'ar-SA'; }, delay: 300 },
          { title: 'Add row', desc: 'Click Add', selector: '#add', run: async () => { addEl.click(); }, delay: 700 },
          { title: 'Play Arabic', desc: 'Play native Arabic pronunciation', selector: '.item:last-of-type .pill[data-lang="ar-SA"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="ar-SA"]'); if(p) p.click(); }, delay: 1600 },
          { title: 'Play English', desc: 'Play English pronunciation', selector: '.item:last-of-type .pill[data-lang="en-US"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="en-US"]'); if(p) p.click(); }, delay: 1600 },
          // Japanese name
          { title: 'Add Japanese example', desc: 'Type English rendering', selector: '#text_en', run: async () => new Promise(res=> typeInto(textEnEl, 'Yuki Tanaka', res)), delay: 400 },
          { title: 'Keep English', desc: 'English text is set', selector: '#lang_en', run: async () => { langEnEl.value = 'en-US'; }, delay: 300 },
          { title: 'Type native Japanese', desc: 'Use Japanese script', selector: '#text_zh', run: async () => new Promise(res=> typeInto(textZhEl, '田中 友紀', res)), delay: 400 },
          { title: 'Choose Japanese', desc: 'Set native language to Japanese', selector: '#lang_zh', run: async () => { langZhEl.value = 'ja-JP'; }, delay: 300 },
          { title: 'Add row', desc: 'Click Add', selector: '#add', run: async () => { addEl.click(); }, delay: 700 },
          { title: 'Play Japanese', desc: 'Play native Japanese pronunciation', selector: '.item:last-of-type .pill[data-lang="ja-JP"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="ja-JP"]'); if(p) p.click(); }, delay: 1600 },
          { title: 'Play English', desc: 'Play English pronunciation', selector: '.item:last-of-type .pill[data-lang="en-US"]', run: async () => { const p = document.querySelector('.item:last-of-type .pill[data-lang="en-US"]'); if(p) p.click(); }, delay: 1600 },
          { title: 'That’s it', desc: 'You can add more rows and copy link to share.', selector: '.footer', run: async () => {}, delay: 1200 }
        ];

        let stepIndex = 0, paused = false, timer = null;

        async function runStep(){
          if(paused) return;
          const step = steps[stepIndex];
          if(!step){ finish(); return; }
          document.getElementById('guide-title').textContent = step.title;
          document.getElementById('guide-desc').textContent = step.desc;
          progress(stepIndex, steps.length);
          setHighlight(step.selector);
          try { await step.run(); } catch(_){ }
          timer = setTimeout(()=>{ stepIndex += 1; runStep(); }, Math.round((step.delay || 800) * BASE));
        }

        function start(){
          if(!document.getElementById('guide-overlay')) makeOverlay();
          stepIndex = 0; paused = false; clearTimeout(timer); runStep();
          try{ localStorage.setItem(SEEN_KEY, '1'); }catch(_){ }
          const cta = document.getElementById('guide-cta'); if(cta) cta.remove();
          const t = document.getElementById('guide-toggle');
          const s = document.getElementById('guide-skip');
          const r = document.getElementById('guide-replay');
          if(t){ t.onclick = ()=>{ paused = !paused; t.textContent = paused ? 'Resume' : 'Pause'; if(!paused) runStep(); else clearTimeout(timer); }; }
          if(s){ s.onclick = ()=>{ clearTimeout(timer); stepIndex += 1; runStep(); }; }
          if(r){ r.onclick = ()=>{ clearTimeout(timer); stepIndex = 0; paused = false; document.getElementById('guide-toggle').textContent = 'Pause'; runStep(); }; }
        }

        function finish(){
          // Ask whether to remove demo permanently
          const ov = document.getElementById('guide-overlay'); if(!ov) return;
          const title = document.getElementById('guide-title');
          const desc = document.getElementById('guide-desc');
          if(title) title.textContent = 'Demo complete';
          if(desc) desc.textContent = 'Would you like to hide the guided demo from this page?';
          const bar = document.getElementById('guide-progress'); if(bar) bar.style.width = '100%';
          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '6px';
          actions.style.marginTop = '8px';
          actions.innerHTML = `
            <button id="guide-remove" style="padding:6px 10px; border-radius:8px; background:#dc2626; color:#ffffff; font-size:12px">Remove</button>
            <button id="guide-keep" style="padding:6px 10px; border-radius:8px; background:#10b981; color:#ffffff; font-size:12px">Keep</button>
          `;
          ov.appendChild(actions);
          const rm = document.getElementById('guide-remove');
          const kp = document.getElementById('guide-keep');
          if(rm){ rm.onclick = ()=>{ try{ localStorage.setItem(HIDE_KEY, '1'); }catch(_){ } const cta = document.getElementById('guide-cta'); if(cta) cta.remove(); ov.remove(); const hi = document.getElementById('guide-highlight'); if(hi) hi.remove(); }; }
          if(kp){ kp.onclick = ()=>{ ov.remove(); const hi = document.getElementById('guide-highlight'); if(hi) hi.remove(); showCTA(); }; }
        }

        function cleanup(){
          const hi = document.getElementById('guide-highlight'); if(hi) hi.remove();
          const ov = document.getElementById('guide-overlay'); if(ov) ov.remove();
        }

        function showCTA(){
          try{ if(localStorage.getItem(HIDE_KEY) === '1') return; }catch(_){ }
          if(document.getElementById('guide-cta')) return;
          const banner = document.createElement('div');
          banner.id = 'guide-cta';
          banner.style.margin = '8px 0 12px';
          banner.style.padding = '10px 12px';
          banner.style.border = '1px solid #c7d2fe';
          banner.style.background = '#eef2ff';
          banner.style.borderRadius = '10px';
          banner.style.display = 'flex';
          banner.style.justifyContent = 'space-between';
          banner.style.alignItems = 'center';
          banner.style.gap = '8px';
          banner.innerHTML = `
            <div style="font-size:13px; color:#3730a3; font-weight:600">Try the guided demo</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap">
              <button id="guide-start" style="padding:6px 10px; border-radius:8px; background:#4f46e5; color:#ffffff; font-size:12px; border:none">Start</button>
              <button id="guide-dismiss" style="padding:6px 10px; border-radius:8px; background:#e0e7ff; color:#3730a3; font-size:12px; border:1px solid #c7d2fe">Dismiss</button>
            </div>
          `;
          const container = document.querySelector('.wrap');
          if(container){ container.insertBefore(banner, container.querySelector('.card') || container.firstChild); }
          const startBtn = banner.querySelector('#guide-start');
          const dismissBtn = banner.querySelector('#guide-dismiss');
          if(startBtn){ startBtn.onclick = ()=> start(); }
          if(dismissBtn){ dismissBtn.onclick = ()=> { try{ localStorage.setItem(HIDE_KEY, '1'); }catch(_){ } banner.remove(); } }
        }

        // legacy guided link removed
        try {
          const u = new URL(window.location.href);
          if(u.searchParams.get('guide') === '1'){ start(); }
          else {
            // First visit hint: show CTA if not hidden
            if(!localStorage.getItem(SEEN_KEY) && !localStorage.getItem(HIDE_KEY)){
              showCTA();
            }
          }
        } catch(_){ showCTA(); }

        // When script finishes all steps (no more step), call finish
        const _origRunStep = runStep;
        runStep = async function(){
          if(paused) return;
          const step = steps[stepIndex];
          if(!step){ finish(); return; }
          await _origRunStep();
        }
      })();
    </script>
  </body>
  </html>
